<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32-CAM æ§åˆ¶é¢æ¿</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 30px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            text-align: center;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .section h2 {
            color: #667eea;
            font-size: 18px;
            margin-bottom: 15px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-size: 14px;
            font-weight: 500;
        }

        input,
        select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .btn-info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        button:active {
            transform: translateY(0);
        }

        .response {
            margin-top: 20px;
            padding: 15px;
            background: #fff;
            border-radius: 6px;
            border: 2px solid #e0e0e0;
            max-height: 300px;
            overflow-y: auto;
        }

        .response h3 {
            color: #333;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .response pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
            line-height: 1.5;
        }

        .video-preview {
            margin-top: 15px;
            border-radius: 8px;
            overflow: hidden;
            background: #000;
        }

        .video-preview img {
            width: 100%;
            height: auto;
            display: block;
        }

        .loading {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #fff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.6s linear infinite;
            margin-left: 8px;
        }

        .status-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #e0e0e0;
        }

        .status-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 8px;
        }

        .status-value {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ¥ ESP32-CAM æ§åˆ¶é¢æ¿</h1>
        <p class="subtitle">å¿«é€Ÿæµ‹è¯•æ‰€æœ‰åŠŸèƒ½</p>

        <!-- åŸºç¡€é…ç½® -->
        <div class="section">
            <h2>âš™ï¸ åŸºç¡€é…ç½®</h2>
            <div class="input-group">
                <label>åç«¯åœ°å€</label>
                <input type="text" id="baseUrl" value="http://192.168.124.68:8080"
                    placeholder="http://192.168.124.68:8080">
            </div>
            <div class="input-group">
                <label>è®¾å¤‡ID (Client ID)</label>
                <input type="text" id="clientId" value="esp32cam" placeholder="esp32cam">
            </div>
        </div>

        <!-- è§†é¢‘æµæ˜¾ç¤º -->
        <div class="section">
            <h2>ğŸ“º å®æ—¶è§†é¢‘æµ</h2>
            <div class="input-group">
                <label>ESP32-CAM IPåœ°å€</label>
                <input type="text" id="esp32Ip" placeholder="192.168.124.100" value="">
            </div>
            <button class="btn-primary" onclick="startStream()" style="width: 100%; margin-bottom: 15px;">â–¶ï¸
                å¯åŠ¨è§†é¢‘æµ</button>
            <div id="streamContainer"
                style="display: none; background: #000; border-radius: 8px; overflow: hidden; position: relative;">
                <img id="videoStream" style="width: 100%; height: auto; display: block;" alt="è§†é¢‘æµåŠ è½½ä¸­...">
                <div style="position: absolute; top: 10px; right: 10px;">
                    <button class="btn-danger" onclick="stopStream()" style="padding: 8px 15px; font-size: 12px;">â¹ï¸
                        åœæ­¢</button>
                </div>
            </div>
        </div>

        <!-- æ‘„åƒå¤´æ§åˆ¶ -->
        <div class="section">
            <h2>ğŸ“· æ‘„åƒå¤´æ§åˆ¶</h2>
            <div class="btn-group">
                <button class="btn-primary" onclick="capture()">ğŸ“¸ æ‹ç…§ (1080p)</button>
                <button class="btn-info" onclick="getStatus()">ğŸ“Š æŸ¥è¯¢çŠ¶æ€</button>
                <button class="btn-success" onclick="setResolution(7)">480p è§†é¢‘æµ</button>
                <button class="btn-success" onclick="setResolution(11)">720p è§†é¢‘æµ</button>
                <button class="btn-warning" onclick="setResolution(14)">1080p è§†é¢‘æµ</button>
            </div>
        </div>

        <!-- LEDæ§åˆ¶ -->
        <div class="section">
            <h2>ğŸ’¡ LED æ§åˆ¶</h2>
            <div class="input-group">
                <label>LEDäº®åº¦ (0-255)</label>
                <input type="range" id="brightness" min="0" max="255" value="128"
                    oninput="document.getElementById('brightnessValue').textContent=this.value">
                <span id="brightnessValue" style="font-weight: bold; color: #667eea;">128</span>
            </div>
            <div class="btn-group">
                <button class="btn-success" onclick="ledControl(1)">ğŸ’¡ LED å¼€</button>
                <button class="btn-danger" onclick="ledControl(0)">ğŸŒ‘ LED å…³</button>
                <button class="btn-info" onclick="setBrightness()">ğŸ”† è®¾ç½®äº®åº¦</button>
            </div>
        </div>

        <!-- é…ç½®ç®¡ç† -->
        <div class="section">
            <h2>ğŸ”§ é…ç½®ç®¡ç†</h2>

            <div class="input-group">
                <label>WiFi SSID</label>
                <input type="text" id="wifiSsid" placeholder="æ–°WiFiåç§°">
            </div>
            <div class="input-group">
                <label>WiFi å¯†ç </label>
                <input type="password" id="wifiPass" placeholder="WiFiå¯†ç ">
            </div>
            <button class="btn-warning" onclick="setWiFi()" style="width: 100%; margin-bottom: 15px;">âš ï¸ è®¾ç½®WiFi
                (è®¾å¤‡å°†é‡å¯)</button>

            <div class="input-group">
                <label>MQTT æœåŠ¡å™¨</label>
                <input type="text" id="mqttServer" placeholder="broker.emqx.io">
            </div>
            <div class="input-group">
                <label>MQTT ç«¯å£</label>
                <input type="number" id="mqttPort" value="1883">
            </div>
            <button class="btn-warning" onclick="setMQTT()" style="width: 100%; margin-bottom: 15px;">âš ï¸ è®¾ç½®MQTT
                (è®¾å¤‡å°†é‡å¯)</button>

            <div class="input-group">
                <label>ä¸Šä¼ URL</label>
                <input type="text" id="uploadUrl" placeholder="http://192.168.124.68:8080/mqtt/cam/upload">
            </div>
            <button class="btn-info" onclick="setUploadUrl()" style="width: 100%; margin-bottom: 15px;">ğŸ’¾
                è®¾ç½®ä¸Šä¼ URL</button>

            <div class="btn-group">
                <button class="btn-info" onclick="getConfig()">ğŸ“‹ æŸ¥è¯¢é…ç½®</button>
                <button class="btn-danger" onclick="resetConfig()">ğŸ”„ æ¢å¤é»˜è®¤</button>
            </div>
        </div>


        <!-- æ‘„åƒå¤´å‚æ•° -->
        <div class="section">
            <h2>ğŸ¨ æ‘„åƒå¤´å‚æ•°è°ƒæ•´</h2>

            <div style="margin-bottom: 15px;">
                <strong>äº®åº¦ (Brightness)</strong>
                <div class="btn-group" style="grid-template-columns: repeat(3, 1fr);">
                    <button class="btn-info" onclick="quickParam('brightness', -2)">ğŸŒ‘ æœ€æš—</button>
                    <button class="btn-info" onclick="quickParam('brightness', 0)">âšª é»˜è®¤</button>
                    <button class="btn-info" onclick="quickParam('brightness', 2)">â˜€ï¸ æœ€äº®</button>
                </div>
            </div>

            <div style="margin-bottom: 15px;">
                <strong>å¯¹æ¯”åº¦ (Contrast)</strong>
                <div class="btn-group" style="grid-template-columns: repeat(3, 1fr);">
                    <button class="btn-info" onclick="quickParam('contrast', -2)">ğŸ“‰ ä½</button>
                    <button class="btn-info" onclick="quickParam('contrast', 0)">âšª é»˜è®¤</button>
                    <button class="btn-info" onclick="quickParam('contrast', 2)">ğŸ“ˆ é«˜</button>
                </div>
            </div>

            <div style="margin-bottom: 15px;">
                <strong>é¥±å’Œåº¦ (Saturation)</strong>
                <div class="btn-group" style="grid-template-columns: repeat(3, 1fr);">
                    <button class="btn-info" onclick="quickParam('saturation', -2)">ğŸ¨ æ·¡</button>
                    <button class="btn-info" onclick="quickParam('saturation', 0)">âšª é»˜è®¤</button>
                    <button class="btn-info" onclick="quickParam('saturation', 2)">ğŸŒˆ é²œè‰³</button>
                </div>
            </div>

            <div style="margin-bottom: 15px;">
                <strong>ç‰¹æ•ˆ (Special Effect)</strong>
                <div class="btn-group">
                    <button class="btn-primary" onclick="quickParam('special_effect', 0)">æ— ç‰¹æ•ˆ</button>
                    <button class="btn-primary" onclick="quickParam('special_effect', 1)">è´Ÿç‰‡</button>
                    <button class="btn-primary" onclick="quickParam('special_effect', 2)">é»‘ç™½</button>
                    <button class="btn-primary" onclick="quickParam('special_effect', 3)">å¤å¤</button>
                </div>
            </div>

            <div>
                <strong>JPEGè´¨é‡</strong>
                <div class="btn-group" style="grid-template-columns: repeat(3, 1fr);">
                    <button class="btn-success" onclick="quickParam('quality', 10)">ğŸ† é«˜è´¨é‡</button>
                    <button class="btn-success" onclick="quickParam('quality', 20)">âšª æ ‡å‡†</button>
                    <button class="btn-success" onclick="quickParam('quality', 40)">âš¡ å¿«é€Ÿ</button>
                </div>
            </div>
        </div>

        <!-- è®¾å¤‡çŠ¶æ€å¡ç‰‡ -->
        <div class="section" id="statusCard" style="display: none;">
            <h2>ğŸ“Š è®¾å¤‡çŠ¶æ€</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div class="status-item">
                    <div class="status-label">ğŸŸ¢ åœ¨çº¿çŠ¶æ€</div>
                    <div class="status-value" id="statusOnline">-</div>
                </div>
                <div class="status-item">
                    <div class="status-label">â±ï¸ è¿è¡Œæ—¶é—´</div>
                    <div class="status-value" id="statusUptime">-</div>
                </div>
                <div class="status-item">
                    <div class="status-label">ğŸ’¾ ç©ºé—²å†…å­˜</div>
                    <div class="status-value" id="statusMemory">-</div>
                </div>
                <div class="status-item">
                    <div class="status-label">ğŸ“¡ WiFiä¿¡å·</div>
                    <div class="status-value" id="statusSignal">-</div>
                </div>
                <div class="status-item">
                    <div class="status-label">ğŸ’¡ LEDçŠ¶æ€</div>
                    <div class="status-value" id="statusLed">-</div>
                </div>
                <div class="status-item">
                    <div class="status-label">ğŸ”† LEDäº®åº¦</div>
                    <div class="status-value" id="statusBrightness">-</div>
                </div>
                <div class="status-item">
                    <div class="status-label">ğŸ“¹ åˆ†è¾¨ç‡</div>
                    <div class="status-value" id="statusFramesize">-</div>
                </div>
                <div class="status-item">
                    <div class="status-label">ğŸ”„ æœ€åæ›´æ–°</div>
                    <div class="status-value" id="statusLastUpdate">-</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ“œ æ“ä½œæ—¥å¿—</h2>
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button class="btn-info" onclick="loadLogs()">ğŸ”„ åˆ·æ–°æ—¥å¿—</button>
                <label style="display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" id="autoRefresh">
                    <span>è‡ªåŠ¨åˆ·æ–°(5ç§’)</span>
                </label>
            </div>
            <div id="logContainer" style="background: white; border-radius: 8px; max-height: 400px; overflow-y: auto;">
                <!-- æ—¥å¿—å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>

        <!-- å“åº”ç»“æœ -->
        <div class="response">
            <h3>ğŸ“¡ API å“åº”</h3>
            <pre id="responseText">ç­‰å¾…æ“ä½œ...</pre>
        </div>
    </div>

    <script>
        const getBaseUrl = () => document.getElementById('baseUrl').value;
        const getClientId = () => document.getElementById('clientId').value;

        const framesizeMap = {
            7: '480p (HVGA)',
            9: 'SVGA',
            10: 'XGA',
            11: '720p (HD)',
            12: 'SXGA',
            13: 'UXGA',
            14: '1080p (FHD)'
        };

        function showResponse(data, isError = false) {
            const elem = document.getElementById('responseText');
            const timestamp = new Date().toLocaleTimeString();
            elem.textContent = `[${timestamp}] ${isError ? 'âŒ é”™è¯¯' : 'âœ… æˆåŠŸ'}\n${JSON.stringify(data, null, 2)}`;
            elem.style.color = isError ? '#d32f2f' : '#2e7d32';

            // å¦‚æœæ˜¯è®¾å¤‡çŠ¶æ€ï¼Œæ›´æ–°çŠ¶æ€å¡ç‰‡
            if (!isError && data.data && data.data.found) {
                updateStatusCard(data.data);
            }
        }

        function updateStatusCard(status) {
            document.getElementById('statusCard').style.display = 'block';

            // åœ¨çº¿çŠ¶æ€
            const online = status.online ? 'ğŸŸ¢ åœ¨çº¿' : 'ğŸ”´ ç¦»çº¿';
            document.getElementById('statusOnline').textContent = online;
            document.getElementById('statusOnline').style.color = status.online ? '#4caf50' : '#f44336';

            // è¿è¡Œæ—¶é—´
            const uptime = parseInt(status.uptime);
            const hours = Math.floor(uptime / 3600);
            const minutes = Math.floor((uptime % 3600) / 60);
            const seconds = uptime % 60;
            document.getElementById('statusUptime').textContent = `${hours}æ—¶${minutes}åˆ†${seconds}ç§’`;

            // ç©ºé—²å†…å­˜
            const memory = (status.freeHeap / 1024).toFixed(1);
            document.getElementById('statusMemory').textContent = `${memory} KB`;

            // WiFiä¿¡å·å¼ºåº¦
            const rssi = status.rssi;
            let signalText = '';
            let signalColor = '';
            if (rssi > -50) {
                signalText = `${rssi} dBm ğŸ“¶ ä¼˜ç§€`;
                signalColor = '#4caf50';
            } else if (rssi > -70) {
                signalText = `${rssi} dBm ğŸ“¶ è‰¯å¥½`;
                signalColor = '#8bc34a';
            } else if (rssi > -80) {
                signalText = `${rssi} dBm ğŸ“¶ ä¸€èˆ¬`;
                signalColor = '#ff9800';
            } else {
                signalText = `${rssi} dBm ğŸ“¶ è¾ƒå¼±`;
                signalColor = '#f44336';
            }
            document.getElementById('statusSignal').textContent = signalText;
            document.getElementById('statusSignal').style.color = signalColor;

            // LEDçŠ¶æ€
            document.getElementById('statusLed').textContent = status.ledStatus ? 'ğŸ’¡ å¼€å¯' : 'ğŸŒ‘ å…³é—­';
            document.getElementById('statusLed').style.color = status.ledStatus ? '#ffc107' : '#757575';

            // LEDäº®åº¦
            document.getElementById('statusBrightness').textContent = status.ledBrightness;

            // åˆ†è¾¨ç‡
            const framesizeText = framesizeMap[status.framesize] || `æœªçŸ¥ (${status.framesize})`;
            document.getElementById('statusFramesize').textContent = framesizeText;

            // æœ€åæ›´æ–°æ—¶é—´
            const lastUpdate = new Date(parseInt(status.lastUpdateTime));
            const now = new Date();
            const diffSeconds = Math.floor((now - lastUpdate) / 1000);
            document.getElementById('statusLastUpdate').textContent = `${diffSeconds}ç§’å‰`;
        }

        function showLoading(button) {
            const original = button.innerHTML;
            button.innerHTML += '<span class="loading"></span>';
            button.disabled = true;
            return () => {
                button.innerHTML = original;
                button.disabled = false;
            };
        }

        async function apiCall(url, method = 'POST', body = null) {
            try {
                const options = { method };
                if (body) {
                    options.headers = { 'Content-Type': 'application/json' };
                    options.body = JSON.stringify(body);
                }
                const response = await fetch(url, options);
                const data = await response.json();
                showResponse(data, data.code !== 0);
                return data;
            } catch (error) {
                showResponse({ error: error.message }, true);
            }
        }

        // æ‘„åƒå¤´æ§åˆ¶
        async function capture() {
            const btn = event.target;
            const done = showLoading(btn);
            await apiCall(`${getBaseUrl()}/mqtt/capture/${getClientId()}`);
            done();
        }

        async function getStatus() {
            await apiCall(`${getBaseUrl()}/mqtt/status/${getClientId()}`, 'GET');
        }

        async function setResolution(framesize) {
            const btn = event.target;
            const done = showLoading(btn);
            await apiCall(`${getBaseUrl()}/mqtt/stream-resolution/${getClientId()}`, 'POST', { framesize });
            done();

            // æç¤ºç”¨æˆ·åˆ·æ–°è§†é¢‘æµ
            const container = document.getElementById('streamContainer');
            if (container.style.display !== 'none') {
                alert('âœ… åˆ†è¾¨ç‡å·²è®¾ç½®ï¼Œè§†é¢‘æµå°†è‡ªåŠ¨åº”ç”¨æ–°åˆ†è¾¨ç‡');
            }
        }

        // LEDæ§åˆ¶
        async function ledControl(value) {
            const btn = event.target;
            const done = showLoading(btn);
            await apiCall(`${getBaseUrl()}/mqtt/led/${getClientId()}`, 'POST', { value });
            done();
        }

        async function setBrightness() {
            const value = document.getElementById('brightness').value;
            const btn = event.target;
            const done = showLoading(btn);
            await apiCall(`${getBaseUrl()}/mqtt/led-brightness/${getClientId()}`, 'POST', { brightness: parseInt(value) });
            done();
        }

        // é…ç½®ç®¡ç†
        async function setWiFi() {
            const ssid = document.getElementById('wifiSsid').value;
            const password = document.getElementById('wifiPass').value;
            if (!ssid || !password) {
                alert('âŒ è¯·è¾“å…¥WiFiåç§°å’Œå¯†ç ');
                return;
            }
            if (!confirm('âš ï¸ è®¾ç½®WiFiåè®¾å¤‡å°†é‡å¯ï¼Œç¡®è®¤ç»§ç»­ï¼Ÿ')) return;

            const btn = event.target;
            const done = showLoading(btn);
            await apiCall(`${getBaseUrl()}/mqtt/config/wifi/${getClientId()}`, 'POST', { ssid, password });
            done();
        }

        async function setMQTT() {
            const server = document.getElementById('mqttServer').value;
            const port = parseInt(document.getElementById('mqttPort').value);
            if (!server) {
                alert('âŒ è¯·è¾“å…¥MQTTæœåŠ¡å™¨åœ°å€');
                return;
            }
            if (!confirm('âš ï¸ è®¾ç½®MQTTåè®¾å¤‡å°†é‡å¯ï¼Œç¡®è®¤ç»§ç»­ï¼Ÿ')) return;

            const btn = event.target;
            const done = showLoading(btn);
            await apiCall(`${getBaseUrl()}/mqtt/config/mqtt/${getClientId()}`, 'POST', { server, port });
            done();
        }

        async function setUploadUrl() {
            const url = document.getElementById('uploadUrl').value;
            if (!url) {
                alert('âŒ è¯·è¾“å…¥ä¸Šä¼ URL');
                return;
            }
            const btn = event.target;
            const done = showLoading(btn);
            await apiCall(`${getBaseUrl()}/mqtt/config/upload-url/${getClientId()}`, 'POST', { url });
            done();
        }

        async function getConfig() {
            await apiCall(`${getBaseUrl()}/mqtt/config/${getClientId()}`, 'GET');
        }

        async function resetConfig() {
            if (!confirm('âš ï¸ ç¡®è®¤æ¢å¤é»˜è®¤é…ç½®ï¼Ÿè®¾å¤‡å°†é‡å¯ï¼')) return;
            const btn = event.target;
            const done = showLoading(btn);
            await apiCall(`${getBaseUrl()}/mqtt/config/reset/${getClientId()}`, 'POST');
            done();
        }

        // å¿«æ·å‚æ•°è®¾ç½®
        async function quickParam(name, value) {
            const btn = event.target;
            const done = showLoading(btn);
            await apiCall(`${getBaseUrl()}/mqtt/param/${getClientId()}`, 'POST', { name, value });
            done();
        }

        // è§†é¢‘æµæ§åˆ¶
        function startStream() {
            const ip = document.getElementById('esp32Ip').value;
            if (!ip) {
                alert('âŒ è¯·è¾“å…¥ESP32-CAMçš„IPåœ°å€');
                return;
            }

            const streamUrl = `http://${ip}/stream?t=${Date.now()}`;
            const img = document.getElementById('videoStream');
            const container = document.getElementById('streamContainer');

            img.src = streamUrl;
            container.style.display = 'block';

            // ä¿å­˜IPåˆ°localStorage
            localStorage.setItem('esp32_ip', ip);

            showResponse({
                code: 0,
                msg: 'è§†é¢‘æµå·²å¯åŠ¨',
                streamUrl: streamUrl
            });
        }

        function stopStream() {
            const img = document.getElementById('videoStream');
            const container = document.getElementById('streamContainer');

            img.src = '';
            container.style.display = 'none';

            showResponse({
                code: 0,
                msg: 'è§†é¢‘æµå·²åœæ­¢'
            });
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ¢å¤IP
        window.addEventListener('DOMContentLoaded', () => {
            const savedIp = localStorage.getItem('esp32_ip');
            if (savedIp) {
                document.getElementById('esp32Ip').value = savedIp;
            }
        });

        // å®šæ—¶åˆ·æ–°çŠ¶æ€
        setInterval(() => {
            const statusCard = document.getElementById('statusCard');
            if (statusCard.style.display !== 'none') {
                getStatus();
            }
        }, 10000); // æ¯10ç§’è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡

        // åŠ è½½æ—¥å¿—
        async function loadLogs() {
            try {
                const response = await fetch(`${getBaseUrl()}/mqtt/logs/latest?limit=10`);
                const result = await response.json();

                if (result.code === 0 && result.data) {
                    displayLogs(result.data);
                }
            } catch (error) {
                console.error('åŠ è½½æ—¥å¿—å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºæ—¥å¿—
        function displayLogs(logs) {
            const container = document.getElementById('logContainer');
            if (logs.length === 0) {
                container.innerHTML = '<p style="padding: 20px; text-align: center; color: #999;">æš‚æ— æ“ä½œæ—¥å¿—</p>';
                return;
            }

            let html = '<table style="width: 100%; border-collapse: collapse;">';
            html += `
        <thead>
            <tr style="background: #f5f5f5; border-bottom: 2px solid #ddd;">
                <th style="padding: 10px; text-align: left;">æ—¶é—´</th>
                <th style="padding: 10px; text-align: left;">è®¾å¤‡</th>
                <th style="padding: 10px; text-align: left;">æ“ä½œ</th>
                <th style="padding: 10px; text-align: left;">ç»“æœ</th>
            </tr>
        </thead>
        <tbody>
    `;

            logs.forEach(log => {
                const resultColor = log.result === 'success' ? '#4caf50' :
                    log.result === 'failed' ? '#f44336' : '#ff9800';
                const resultText = log.result === 'success' ? 'âœ“ æˆåŠŸ' :
                    log.result === 'failed' ? 'âœ— å¤±è´¥' : 'â³ å¤„ç†ä¸­';

                html += `
            <tr style="border-bottom: 1px solid #eee;">
                <td style="padding: 10px;">${formatTime(log.createTime)}</td>
                <td style="padding: 10px;">${log.clientId}</td>
                <td style="padding: 10px;">${log.operationDesc}</td>
                <td style="padding: 10px; color: ${resultColor}; font-weight: bold;">
                    ${resultText}${log.resultMsg ? ': ' + log.resultMsg : ''}
                </td>
            </tr>
        `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(timeStr) {
            const date = new Date(timeStr);
            return `${date.getMonth() + 1}-${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}:${String(date.getSeconds()).padStart(2, '0')}`;
        }

        // è‡ªåŠ¨åˆ·æ–°
        setInterval(() => {
            if (document.getElementById('autoRefresh').checked) {
                loadLogs();
            }
        }, 5000);

        // é¡µé¢åŠ è½½æ—¶åŠ è½½æ—¥å¿—
        window.addEventListener('DOMContentLoaded', loadLogs);
    </script>
</body>

</html>