<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32-CAM æ§åˆ¶é¢æ¿</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 30px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            text-align: center;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .section h2 {
            color: #667eea;
            font-size: 18px;
            margin-bottom: 15px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-size: 14px;
            font-weight: 500;
        }

        input,
        select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .btn-info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        button:active {
            transform: translateY(0);
        }

        .response {
            margin-top: 20px;
            padding: 15px;
            background: #fff;
            border-radius: 6px;
            border: 2px solid #e0e0e0;
            max-height: 300px;
            overflow-y: auto;
        }

        .response h3 {
            color: #333;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .response pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
            line-height: 1.5;
        }

        .video-preview {
            margin-top: 15px;
            border-radius: 8px;
            overflow: hidden;
            background: #000;
        }

        .video-preview img {
            width: 100%;
            height: auto;
            display: block;
        }

        .loading {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #fff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.6s linear infinite;
            margin-left: 8px;
        }

        .status-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #e0e0e0;
        }

        .status-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 8px;
        }

        .status-value {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ¥ ESP32-CAM æ§åˆ¶é¢æ¿ <span id="sseStatus" style="font-size: 14px; margin-left: 15px; color: #f44336;">ğŸ”´
                ç¦»çº¿</span></h1>
        <p class="subtitle">å¿«é€Ÿæµ‹è¯•æ‰€æœ‰åŠŸèƒ½</p>

        <!-- åŸºç¡€é…ç½® -->
        <div class="section">
            <h2>âš™ï¸ åŸºç¡€é…ç½®</h2>
            <div class="input-group">
                <label>åç«¯åœ°å€</label>
                <input type="text" id="baseUrl" value="http://192.168.124.68:8080"
                    placeholder="http://192.168.124.68:8080">
            </div>
            <div class="input-group">
                <label>è®¾å¤‡ID (Client ID)</label>
                <input type="text" id="clientId" value="esp32cam" placeholder="esp32cam">
            </div>
        </div>

        <!-- è§†é¢‘æµæ˜¾ç¤º -->
        <div class="section">
            <h2>ğŸ“º å®æ—¶è§†é¢‘æµ</h2>
            <div class="input-group">
                <label>ESP32-CAM IPåœ°å€</label>
                <input type="text" id="esp32Ip" placeholder="192.168.124.100" value="">
            </div>
            <button class="btn-primary" onclick="startStream()" style="width: 100%; margin-bottom: 15px;">â–¶ï¸
                å¯åŠ¨è§†é¢‘æµ</button>
            <div id="streamContainer"
                style="display: none; background: #000; border-radius: 8px; overflow: hidden; position: relative;">
                <img id="videoStream" style="width: 100%; height: auto; display: block;" alt="è§†é¢‘æµåŠ è½½ä¸­...">
                <div style="position: absolute; top: 10px; right: 10px;">
                    <button class="btn-danger" onclick="stopStream()" style="padding: 8px 15px; font-size: 12px;">â¹ï¸
                        åœæ­¢</button>
                </div>
            </div>
        </div>

        <!-- æ¸©æ¹¿åº¦ç›‘æ§ -->
        <div class="section">
            <h2>ğŸŒ¡ï¸ æ¸©æ¹¿åº¦ç›‘æ§</h2>
            <div style="display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">
                <div
                    style="flex: 1; min-width: 150px; background: linear-gradient(135deg, #ff6b6b, #ee5a24); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                    <div style="font-size: 14px; opacity: 0.9;">ğŸŒ¡ï¸ æ¸©åº¦</div>
                    <div id="currentTemp" style="font-size: 36px; font-weight: bold; margin: 10px 0;">--</div>
                    <div style="font-size: 14px;">â„ƒ</div>
                </div>
                <div
                    style="flex: 1; min-width: 150px; background: linear-gradient(135deg, #74b9ff, #0984e3); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                    <div style="font-size: 14px; opacity: 0.9;">ğŸ’§ æ¹¿åº¦</div>
                    <div id="currentHumidity" style="font-size: 36px; font-weight: bold; margin: 10px 0;">--</div>
                    <div style="font-size: 14px;">%</div>
                </div>
                <div
                    style="flex: 1; min-width: 150px; background: linear-gradient(135deg, #a29bfe, #6c5ce7); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                    <div style="font-size: 14px; opacity: 0.9;">â›±ï¸ æ›´æ–°æ—¶é—´</div>
                    <div id="dhtUpdateTime" style="font-size: 24px; font-weight: bold; margin: 10px 0;">--:--:--</div>
                    <div style="font-size: 14px;">å®æ—¶</div>
                </div>
            </div>
            <div style="background: #f8f9fa; border-radius: 12px; padding: 15px;">
                <canvas id="dhtChart" height="200"></canvas>
            </div>
            <div style="margin-top: 15px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <label style="font-weight: bold;">â±ï¸ è¯»å–é—´éš”:</label>
                <select id="dhtInterval" style="padding: 8px 12px; border-radius: 6px; border: 1px solid #ddd;">
                    <option value="1000">1ç§’</option>
                    <option value="2000">2ç§’</option>
                    <option value="5000">5ç§’</option>
                    <option value="10000">10ç§’</option>
                    <option value="30000">30ç§’</option>
                    <option value="60000">60ç§’</option>
                </select>
                <button class="btn-info" onclick="setDhtInterval()">ğŸ“¤ è®¾ç½®é—´éš”</button>
            </div>
        </div>

        <!-- æ‘„åƒå¤´æ§åˆ¶ -->
        <div class="section">
            <h2>ğŸ“· æ‘„åƒå¤´æ§åˆ¶</h2>
            <div class="btn-group">
                <button class="btn-primary" onclick="capture()">ğŸ“¸ æ‹ç…§ (1080p)</button>
                <button class="btn-success" onclick="setResolution(7)">480p è§†é¢‘æµ</button>
                <button class="btn-success" onclick="setResolution(11)">720p è§†é¢‘æµ</button>
                <button class="btn-warning" onclick="setResolution(14)">1080p è§†é¢‘æµ</button>
            </div>
        </div>

        <!-- LEDæ§åˆ¶ -->
        <div class="section">
            <h2>ğŸ’¡ LED æ§åˆ¶</h2>
            <div class="input-group">
                <label>LEDäº®åº¦ (0-255)</label>
                <input type="range" id="brightness" min="0" max="255" value="0"
                    oninput="document.getElementById('brightnessValue').textContent=this.value">
                <span id="brightnessValue" style="font-weight: bold; color: #667eea;">--</span>
            </div>
            <div class="btn-group">
                <button class="btn-success" onclick="ledControl(1)">ğŸ’¡ LED å¼€</button>
                <button class="btn-danger" onclick="ledControl(0)">ğŸŒ‘ LED å…³</button>
            </div>
            <div class="btn-group" style="margin-top: 10px;">
                <button class="btn-success" onclick="redLedControl(1)">ğŸ”´ æŒ‡ç¤ºç¯ å¼€</button>
                <button class="btn-danger" onclick="redLedControl(0)">âš« æŒ‡ç¤ºç¯ å…³</button>
            </div>
        </div>

        <!-- è®¾å¤‡çŠ¶æ€ -->
        <div class="section">
            <h2>ğŸ“Š è®¾å¤‡çŠ¶æ€ <span id="statusLoading" class="loading" style="display: none;"></span></h2>
            <div id="deviceStatusPanel" style="display: none;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px;">
                    <div
                        style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 15px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 12px; opacity: 0.9;">â±ï¸ è¿è¡Œæ—¶é—´</div>
                        <div id="statusUptime" style="font-size: 20px; font-weight: bold; margin: 5px 0;">--</div>
                    </div>
                    <div
                        style="background: linear-gradient(135deg, #11998e, #38ef7d); color: white; padding: 15px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 12px; opacity: 0.9;">ğŸ’¾ ç©ºé—²å†…å­˜</div>
                        <div id="statusFreeHeap" style="font-size: 20px; font-weight: bold; margin: 5px 0;">--</div>
                    </div>
                    <div
                        style="background: linear-gradient(135deg, #f093fb, #f5576c); color: white; padding: 15px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 12px; opacity: 0.9;">ğŸ“¶ WiFiä¿¡å·</div>
                        <div id="statusRssi" style="font-size: 20px; font-weight: bold; margin: 5px 0;">--</div>
                    </div>
                    <div
                        style="background: linear-gradient(135deg, #4facfe, #00f2fe); color: white; padding: 15px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 12px; opacity: 0.9;">ğŸ’¡ LEDäº®åº¦</div>
                        <div id="statusLedBrightness" style="font-size: 20px; font-weight: bold; margin: 5px 0;">--
                        </div>
                    </div>
                    <div
                        style="background: linear-gradient(135deg, #fa709a, #fee140); color: white; padding: 15px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 12px; opacity: 0.9;">ğŸ“· åˆ†è¾¨ç‡</div>
                        <div id="statusFramesize" style="font-size: 20px; font-weight: bold; margin: 5px 0;">--</div>
                    </div>
                    <div
                        style="background: linear-gradient(135deg, #a8edea, #fed6e3); color: #333; padding: 15px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 12px; opacity: 0.8;">ğŸ”Œ DHTé—´éš”</div>
                        <div id="statusDhtInterval" style="font-size: 20px; font-weight: bold; margin: 5px 0;">--</div>
                    </div>
                </div>
            </div>
            <div id="deviceStatusLoading" style="text-align: center; padding: 30px; color: #888;">
                <div class="loading" style="width: 30px; height: 30px; margin: 0 auto 10px;"></div>
                <div>ç­‰å¾…è®¾å¤‡é…ç½®...</div>
            </div>
        </div>

        <!-- é…ç½®ç®¡ç† -->
        <div class="section">
            <h2>ğŸ”§ é…ç½®ç®¡ç†</h2>

            <div class="input-group">
                <label>WiFi SSID</label>
                <input type="text" id="wifiSsid" placeholder="æ–°WiFiåç§°">
            </div>
            <div class="input-group">
                <label>WiFi å¯†ç </label>
                <input type="password" id="wifiPass" placeholder="WiFiå¯†ç ">
            </div>
            <button class="btn-warning" onclick="setWiFi()" style="width: 100%; margin-bottom: 15px;">âš ï¸ è®¾ç½®WiFi
                (è®¾å¤‡å°†é‡å¯)</button>

            <div class="input-group">
                <label>MQTT æœåŠ¡å™¨</label>
                <input type="text" id="mqttServer" placeholder="broker.emqx.io">
            </div>
            <div class="input-group">
                <label>MQTT ç«¯å£</label>
                <input type="number" id="mqttPort" placeholder="1883">
            </div>
            <button class="btn-warning" onclick="setMQTT()" style="width: 100%; margin-bottom: 15px;">âš ï¸ è®¾ç½®MQTT
                (è®¾å¤‡å°†é‡å¯)</button>

            <div class="input-group">
                <label>ä¸Šä¼ URL</label>
                <input type="text" id="uploadUrl" placeholder="http://192.168.124.68:8080/mqtt/cam/upload">
            </div>
            <button class="btn-info" onclick="setUploadUrl()" style="width: 100%; margin-bottom: 15px;">ğŸ’¾
                è®¾ç½®ä¸Šä¼ URL</button>

            <div class="btn-group">
                <button class="btn-info" onclick="getConfig()">ğŸ“‹ æŸ¥è¯¢é…ç½®</button>
                <button class="btn-danger" onclick="resetConfig()">ğŸ”„ æ¢å¤é»˜è®¤</button>
            </div>
        </div>


        <!-- æ‘„åƒå¤´å‚æ•° -->
        <div class="section">
            <h2>ğŸ¨ æ‘„åƒå¤´å‚æ•°è°ƒæ•´</h2>

            <div style="margin-bottom: 15px;">
                <strong>äº®åº¦ (Brightness)</strong>
                <div class="btn-group" style="grid-template-columns: repeat(3, 1fr);">
                    <button class="btn-info" onclick="quickParam('brightness', -2)">ğŸŒ‘ æœ€æš—</button>
                    <button class="btn-info" onclick="quickParam('brightness', 0)">âšª é»˜è®¤</button>
                    <button class="btn-info" onclick="quickParam('brightness', 2)">â˜€ï¸ æœ€äº®</button>
                </div>
            </div>

            <div style="margin-bottom: 15px;">
                <strong>å¯¹æ¯”åº¦ (Contrast)</strong>
                <div class="btn-group" style="grid-template-columns: repeat(3, 1fr);">
                    <button class="btn-info" onclick="quickParam('contrast', -2)">ğŸ“‰ ä½</button>
                    <button class="btn-info" onclick="quickParam('contrast', 0)">âšª é»˜è®¤</button>
                    <button class="btn-info" onclick="quickParam('contrast', 2)">ğŸ“ˆ é«˜</button>
                </div>
            </div>

            <div style="margin-bottom: 15px;">
                <strong>é¥±å’Œåº¦ (Saturation)</strong>
                <div class="btn-group" style="grid-template-columns: repeat(3, 1fr);">
                    <button class="btn-info" onclick="quickParam('saturation', -2)">ğŸ¨ æ·¡</button>
                    <button class="btn-info" onclick="quickParam('saturation', 0)">âšª é»˜è®¤</button>
                    <button class="btn-info" onclick="quickParam('saturation', 2)">ğŸŒˆ é²œè‰³</button>
                </div>
            </div>

            <div style="margin-bottom: 15px;">
                <strong>ç‰¹æ•ˆ (Special Effect)</strong>
                <div class="btn-group">
                    <button class="btn-primary" onclick="quickParam('special_effect', 0)">æ— ç‰¹æ•ˆ</button>
                    <button class="btn-primary" onclick="quickParam('special_effect', 1)">è´Ÿç‰‡</button>
                    <button class="btn-primary" onclick="quickParam('special_effect', 2)">é»‘ç™½</button>
                    <button class="btn-primary" onclick="quickParam('special_effect', 3)">å¤å¤</button>
                </div>
            </div>

            <div>
                <strong>JPEGè´¨é‡</strong>
                <div class="btn-group" style="grid-template-columns: repeat(3, 1fr);">
                    <button class="btn-success" onclick="quickParam('quality', 10)">ğŸ† é«˜è´¨é‡</button>
                    <button class="btn-success" onclick="quickParam('quality', 20)">âšª æ ‡å‡†</button>
                    <button class="btn-success" onclick="quickParam('quality', 40)">âš¡ å¿«é€Ÿ</button>
                </div>
            </div>
        </div>

        <!-- è®¾å¤‡çŠ¶æ€å¡ç‰‡ -->
        <div class="section" id="statusCard" style="display: none;">
            <h2>ğŸ“Š è®¾å¤‡çŠ¶æ€</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div class="status-item">
                    <div class="status-label">ğŸŸ¢ åœ¨çº¿çŠ¶æ€</div>
                    <div class="status-value" id="statusOnline">-</div>
                </div>
                <div class="status-item">
                    <div class="status-label">â±ï¸ è¿è¡Œæ—¶é—´</div>
                    <div class="status-value" id="statusUptime">-</div>
                </div>
                <div class="status-item">
                    <div class="status-label">ğŸ’¾ ç©ºé—²å†…å­˜</div>
                    <div class="status-value" id="statusMemory">-</div>
                </div>
                <div class="status-item">
                    <div class="status-label">ğŸ“¡ WiFiä¿¡å·</div>
                    <div class="status-value" id="statusSignal">-</div>
                </div>
                <div class="status-item">
                    <div class="status-label">ğŸ’¡ LEDçŠ¶æ€</div>
                    <div class="status-value" id="statusLed">-</div>
                </div>
                <div class="status-item">
                    <div class="status-label">ğŸ”† LEDäº®åº¦</div>
                    <div class="status-value" id="statusBrightness">-</div>
                </div>
                <div class="status-item">
                    <div class="status-label">ğŸ“¹ åˆ†è¾¨ç‡</div>
                    <div class="status-value" id="statusFramesize">-</div>
                </div>
                <div class="status-item">
                    <div class="status-label">ğŸ”„ æœ€åæ›´æ–°</div>
                    <div class="status-value" id="statusLastUpdate">-</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ“œ æ“ä½œæ—¥å¿— <span style="font-size: 12px; color: #4caf50; font-weight: normal;">ğŸ”´ å®æ—¶æ¨é€</span></h2>
            <div id="logContainer" style="background: white; border-radius: 8px; max-height: 400px; overflow-y: auto;">
                <!-- æ—¥å¿—å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>

        <!-- å“åº”ç»“æœ -->
        <div class="response">
            <h3>ğŸ“¡ API å“åº”</h3>
            <pre id="responseText">ç­‰å¾…æ“ä½œ...</pre>
        </div>
    </div>

    <script>
        const getBaseUrl = () => document.getElementById('baseUrl').value;
        const getClientId = () => document.getElementById('clientId').value;

        const framesizeMap = {
            7: '480p (HVGA)',
            9: 'SVGA',
            10: 'XGA',
            11: '720p (HD)',
            12: 'SXGA',
            13: 'UXGA',
            14: '1080p (FHD)'
        };

        function showResponse(data, isError = false) {
            const elem = document.getElementById('responseText');
            const timestamp = new Date().toLocaleTimeString();
            elem.textContent = `[${timestamp}] ${isError ? 'âŒ é”™è¯¯' : 'âœ… æˆåŠŸ'}\n${JSON.stringify(data, null, 2)}`;
            elem.style.color = isError ? '#d32f2f' : '#2e7d32';

            // å¦‚æœæ˜¯è®¾å¤‡çŠ¶æ€ï¼Œæ›´æ–°çŠ¶æ€å¡ç‰‡
            if (!isError && data.data && data.data.found) {
                updateStatusCard(data.data);
            }
        }

        function updateStatusCard(status) {
            document.getElementById('statusCard').style.display = 'block';

            // åœ¨çº¿çŠ¶æ€
            const online = status.online ? 'ğŸŸ¢ åœ¨çº¿' : 'ğŸ”´ ç¦»çº¿';
            document.getElementById('statusOnline').textContent = online;
            document.getElementById('statusOnline').style.color = status.online ? '#4caf50' : '#f44336';

            // è¿è¡Œæ—¶é—´
            const uptime = parseInt(status.uptime);
            const hours = Math.floor(uptime / 3600);
            const minutes = Math.floor((uptime % 3600) / 60);
            const seconds = uptime % 60;
            document.getElementById('statusUptime').textContent = `${hours}æ—¶${minutes}åˆ†${seconds}ç§’`;

            // ç©ºé—²å†…å­˜
            const memory = (status.freeHeap / 1024).toFixed(1);
            document.getElementById('statusMemory').textContent = `${memory} KB`;

            // WiFiä¿¡å·å¼ºåº¦
            const rssi = status.rssi;
            let signalText = '';
            let signalColor = '';
            if (rssi > -50) {
                signalText = `${rssi} dBm ğŸ“¶ ä¼˜ç§€`;
                signalColor = '#4caf50';
            } else if (rssi > -70) {
                signalText = `${rssi} dBm ğŸ“¶ è‰¯å¥½`;
                signalColor = '#8bc34a';
            } else if (rssi > -80) {
                signalText = `${rssi} dBm ğŸ“¶ ä¸€èˆ¬`;
                signalColor = '#ff9800';
            } else {
                signalText = `${rssi} dBm ğŸ“¶ è¾ƒå¼±`;
                signalColor = '#f44336';
            }
            document.getElementById('statusSignal').textContent = signalText;
            document.getElementById('statusSignal').style.color = signalColor;

            // LEDçŠ¶æ€
            document.getElementById('statusLed').textContent = status.ledStatus ? 'ğŸ’¡ å¼€å¯' : 'ğŸŒ‘ å…³é—­';
            document.getElementById('statusLed').style.color = status.ledStatus ? '#ffc107' : '#757575';

            // LEDäº®åº¦
            document.getElementById('statusBrightness').textContent = status.ledBrightness;

            // åˆ†è¾¨ç‡
            const framesizeText = framesizeMap[status.framesize] || `æœªçŸ¥ (${status.framesize})`;
            document.getElementById('statusFramesize').textContent = framesizeText;

            // æœ€åæ›´æ–°æ—¶é—´
            const lastUpdate = new Date(parseInt(status.lastUpdateTime));
            const now = new Date();
            const diffSeconds = Math.floor((now - lastUpdate) / 1000);
            document.getElementById('statusLastUpdate').textContent = `${diffSeconds}ç§’å‰`;
        }

        function showLoading(button) {
            const original = button.innerHTML;
            button.innerHTML += '<span class="loading"></span>';
            button.disabled = true;
            return () => {
                button.innerHTML = original;
                button.disabled = false;
            };
        }

        async function apiCall(url, method = 'POST', body = null) {
            try {
                const options = { method };
                if (body) {
                    options.headers = { 'Content-Type': 'application/json' };
                    options.body = JSON.stringify(body);
                }
                const response = await fetch(url, options);
                const data = await response.json();
                showResponse(data, data.code !== 0);
                return data;
            } catch (error) {
                showResponse({ error: error.message }, true);
            }
        }

        // æ‘„åƒå¤´æ§åˆ¶
        async function capture() {
            const btn = event.target;
            const done = showLoading(btn);
            await apiCall(`${getBaseUrl()}/mqtt/capture/${getClientId()}`);
            done();
        }

        async function getStatus() {
            await apiCall(`${getBaseUrl()}/mqtt/status/${getClientId()}`, 'GET');
        }

        async function setResolution(framesize) {
            const btn = event.target;
            const done = showLoading(btn);
            await apiCall(`${getBaseUrl()}/mqtt/stream-resolution/${getClientId()}`, 'POST', { framesize });
            done();

            // æç¤ºç”¨æˆ·åˆ·æ–°è§†é¢‘æµ
            const container = document.getElementById('streamContainer');
            if (container.style.display !== 'none') {
                alert('âœ… åˆ†è¾¨ç‡å·²è®¾ç½®ï¼Œè§†é¢‘æµå°†è‡ªåŠ¨åº”ç”¨æ–°åˆ†è¾¨ç‡');
            }
        }

        // LEDæ§åˆ¶
        async function ledControl(value) {
            const btn = event.target;
            const done = showLoading(btn);
            await apiCall(`${getBaseUrl()}/mqtt/led/${getClientId()}`, 'POST', { value });
            done();
        }

        async function setBrightness() {
            const value = document.getElementById('brightness').value;
            const btn = event.target;
            const done = showLoading(btn);
            await apiCall(`${getBaseUrl()}/mqtt/led-brightness/${getClientId()}`, 'POST', { brightness: parseInt(value) });
            done();
        }

        // è®¾ç½®DHTè¯»å–é—´éš”
        async function setDhtInterval() {
            const interval = parseInt(document.getElementById('dhtInterval').value);
            const btn = event.target;
            const done = showLoading(btn);
            await apiCall(`${getBaseUrl()}/mqtt/dht-interval/${getClientId()}`, 'POST', { interval });
            done();
        }

        // çº¢è‰²æŒ‡ç¤ºç¯æ§åˆ¶
        async function redLedControl(value) {
            const btn = event.target;
            const done = showLoading(btn);
            await apiCall(`${getBaseUrl()}/mqtt/red-led/${getClientId()}`, 'POST', { value });
            done();
        }

        // é…ç½®ç®¡ç†
        async function setWiFi() {
            const ssid = document.getElementById('wifiSsid').value;
            const password = document.getElementById('wifiPass').value;
            if (!ssid || !password) {
                alert('âŒ è¯·è¾“å…¥WiFiåç§°å’Œå¯†ç ');
                return;
            }
            if (!confirm('âš ï¸ è®¾ç½®WiFiåè®¾å¤‡å°†é‡å¯ï¼Œç¡®è®¤ç»§ç»­ï¼Ÿ')) return;

            const btn = event.target;
            const done = showLoading(btn);
            await apiCall(`${getBaseUrl()}/mqtt/config/wifi/${getClientId()}`, 'POST', { ssid, password });
            done();
        }

        async function setMQTT() {
            const server = document.getElementById('mqttServer').value;
            const port = parseInt(document.getElementById('mqttPort').value);
            if (!server) {
                alert('âŒ è¯·è¾“å…¥MQTTæœåŠ¡å™¨åœ°å€');
                return;
            }
            if (!confirm('âš ï¸ è®¾ç½®MQTTåè®¾å¤‡å°†é‡å¯ï¼Œç¡®è®¤ç»§ç»­ï¼Ÿ')) return;

            const btn = event.target;
            const done = showLoading(btn);
            await apiCall(`${getBaseUrl()}/mqtt/config/mqtt/${getClientId()}`, 'POST', { server, port });
            done();
        }

        async function setUploadUrl() {
            const url = document.getElementById('uploadUrl').value;
            if (!url) {
                alert('âŒ è¯·è¾“å…¥ä¸Šä¼ URL');
                return;
            }
            const btn = event.target;
            const done = showLoading(btn);
            await apiCall(`${getBaseUrl()}/mqtt/config/upload-url/${getClientId()}`, 'POST', { url });
            done();
        }

        async function getConfig() {
            await apiCall(`${getBaseUrl()}/mqtt/config/${getClientId()}`, 'GET');
        }

        async function resetConfig() {
            if (!confirm('âš ï¸ ç¡®è®¤æ¢å¤é»˜è®¤é…ç½®ï¼Ÿè®¾å¤‡å°†é‡å¯ï¼')) return;
            const btn = event.target;
            const done = showLoading(btn);
            await apiCall(`${getBaseUrl()}/mqtt/config/reset/${getClientId()}`, 'POST');
            done();
        }

        // å¿«æ·å‚æ•°è®¾ç½®
        async function quickParam(name, value) {
            const btn = event.target;
            const done = showLoading(btn);
            await apiCall(`${getBaseUrl()}/mqtt/param/${getClientId()}`, 'POST', { name, value });
            done();
        }

        // è§†é¢‘æµæ§åˆ¶
        function startStream() {
            const ip = document.getElementById('esp32Ip').value;
            if (!ip) {
                alert('âŒ è¯·è¾“å…¥ESP32-CAMçš„IPåœ°å€');
                return;
            }

            const streamUrl = `http://${ip}/stream?t=${Date.now()}`;
            const img = document.getElementById('videoStream');
            const container = document.getElementById('streamContainer');

            img.src = streamUrl;
            container.style.display = 'block';

            // ä¿å­˜IPåˆ°localStorage
            localStorage.setItem('esp32_ip', ip);

            showResponse({
                code: 0,
                msg: 'è§†é¢‘æµå·²å¯åŠ¨',
                streamUrl: streamUrl
            });
        }

        function stopStream() {
            const img = document.getElementById('videoStream');
            const container = document.getElementById('streamContainer');

            img.src = '';
            container.style.display = 'none';

            showResponse({
                code: 0,
                msg: 'è§†é¢‘æµå·²åœæ­¢'
            });
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ¢å¤IP
        window.addEventListener('DOMContentLoaded', () => {
            const savedIp = localStorage.getItem('esp32_ip');
            if (savedIp) {
                document.getElementById('esp32Ip').value = savedIp;
            }
        });

        // å®šæ—¶åˆ·æ–°çŠ¶æ€
        setInterval(() => {
            const statusCard = document.getElementById('statusCard');
            if (statusCard.style.display !== 'none') {
                getStatus();
            }
        }, 10000); // æ¯10ç§’è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡

        // åŠ è½½æ—¥å¿—
        async function loadLogs() {
            try {
                const response = await fetch(`${getBaseUrl()}/mqtt/logs/latest?limit=10`);
                const result = await response.json();

                if (result.code === 0 && result.data) {
                    displayLogs(result.data);
                }
            } catch (error) {
                console.error('åŠ è½½æ—¥å¿—å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºæ—¥å¿—
        function displayLogs(logs) {
            const container = document.getElementById('logContainer');
            if (logs.length === 0) {
                container.innerHTML = '<p style="padding: 20px; text-align: center; color: #999;">æš‚æ— æ“ä½œæ—¥å¿—</p>';
                return;
            }

            let html = '<table style="width: 100%; border-collapse: collapse;">';
            html += `
        <thead>
            <tr style="background: #f5f5f5; border-bottom: 2px solid #ddd;">
                <th style="padding: 10px; text-align: left;">æ—¶é—´</th>
                <th style="padding: 10px; text-align: left;">è®¾å¤‡</th>
                <th style="padding: 10px; text-align: left;">æ“ä½œ</th>
                <th style="padding: 10px; text-align: left;">ç»“æœ</th>
            </tr>
        </thead>
        <tbody>
    `;

            logs.forEach(log => {
                const resultColor = log.result === 'success' ? '#4caf50' :
                    log.result === 'failed' ? '#f44336' : '#ff9800';
                const resultText = log.result === 'success' ? 'âœ“ æˆåŠŸ' :
                    log.result === 'failed' ? 'âœ— å¤±è´¥' : 'â³ å¤„ç†ä¸­';

                html += `
            <tr style="border-bottom: 1px solid #eee;">
                <td style="padding: 10px;">${formatTime(log.createTime)}</td>
                <td style="padding: 10px;">${log.clientId}</td>
                <td style="padding: 10px;">${log.operationDesc}</td>
                <td style="padding: 10px; color: ${resultColor}; font-weight: bold;">
                    ${resultText}${log.resultMsg ? ': ' + log.resultMsg : ''}
                </td>
            </tr>
        `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(timeStr) {
            const date = new Date(timeStr);
            return `${date.getMonth() + 1}-${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}:${String(date.getSeconds()).padStart(2, '0')}`;
        }

        // SSEæ¨é€æ—¶å¤„ç†æ—¥å¿—
        // pendingçŠ¶æ€ï¼šæ’å…¥æ–°è¡Œ
        // success/failedçŠ¶æ€ï¼šæ›´æ–°å¯¹åº”çš„pendingè¡Œ
        function addLogToTop(logData) {
            const container = document.getElementById('logContainer');
            let tbody = container.querySelector('tbody');

            // å¦‚æœæ²¡æœ‰è¡¨æ ¼ï¼Œåˆå§‹åŒ–ä¸€ä¸ª
            if (!tbody) {
                container.innerHTML = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f5f5f5; border-bottom: 2px solid #ddd;">
                                <th style="padding: 10px; text-align: left;">æ—¶é—´</th>
                                <th style="padding: 10px; text-align: left;">è®¾å¤‡</th>
                                <th style="padding: 10px; text-align: left;">æ“ä½œ</th>
                                <th style="padding: 10px; text-align: left;">ç»“æœ</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>`;
                tbody = container.querySelector('tbody');
            }

            const resultColor = logData.result === 'success' ? '#4caf50' :
                logData.result === 'failed' ? '#f44336' : '#ff9800';
            const resultText = logData.result === 'success' ? 'âœ“ æˆåŠŸ' :
                logData.result === 'failed' ? 'âœ— å¤±è´¥' : 'â³ å¤„ç†ä¸­';

            // å¦‚æœæ˜¯successæˆ–failedï¼Œå°è¯•æ‰¾åˆ°å¹¶æ›´æ–°pendingè¡Œ
            if (logData.result !== 'pending') {
                const rows = tbody.querySelectorAll('tr[data-operation]');
                for (const row of rows) {
                    if (row.dataset.operation === logData.operation && row.dataset.status === 'pending') {
                        // æ›´æ–°è¿™ä¸€è¡Œ
                        row.dataset.status = logData.result;
                        row.querySelector('.result-cell').innerHTML =
                            `<span style="color: ${resultColor}; font-weight: bold;">${resultText}${logData.resultMsg ? ': ' + logData.resultMsg : ''}</span>`;
                        row.style.backgroundColor = logData.result === 'success' ? '#e8f5e9' : '#ffebee';
                        setTimeout(() => {
                            row.style.transition = 'background-color 0.5s';
                            row.style.backgroundColor = '';
                        }, 500);
                        return; // å·²æ›´æ–°ï¼Œä¸éœ€è¦æ’å…¥æ–°è¡Œ
                    }
                }
            }

            // æ’å…¥æ–°è¡Œ
            const newRow = document.createElement('tr');
            newRow.dataset.operation = logData.operation;
            newRow.dataset.status = logData.result;
            newRow.style.borderBottom = '1px solid #eee';
            newRow.style.backgroundColor = '#fffde7';
            newRow.innerHTML = `
                <td style="padding: 10px;">${logData.time}</td>
                <td style="padding: 10px;">${logData.clientId || '-'}</td>
                <td style="padding: 10px;">${logData.operationDesc}</td>
                <td class="result-cell" style="padding: 10px;">
                    <span style="color: ${resultColor}; font-weight: bold;">${resultText}${logData.resultMsg ? ': ' + logData.resultMsg : ''}</span>
                </td>
            `;

            tbody.insertBefore(newRow, tbody.firstChild);

            setTimeout(() => {
                newRow.style.transition = 'background-color 0.5s';
                newRow.style.backgroundColor = '';
            }, 100);

            // ä¿æŒæœ€å¤šæ˜¾ç¤º10æ¡
            while (tbody.children.length > 10) {
                tbody.removeChild(tbody.lastChild);
            }
        }

        // é¡µé¢åŠ è½½æ—¶åŠ è½½å†å²æ—¥å¿—ï¼ˆåˆå§‹åŒ–ï¼‰
        window.addEventListener('DOMContentLoaded', loadLogs);

        // ===========================
        // æ¸©æ¹¿åº¦å›¾è¡¨ç›¸å…³
        // ===========================
        let dhtChart = null;

        // åˆå§‹åŒ–æ¸©æ¹¿åº¦å›¾è¡¨
        function initDhtChart() {
            const ctx = document.getElementById('dhtChart').getContext('2d');
            dhtChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'æ¸©åº¦ (â„ƒ)',
                            data: [],
                            borderColor: '#ff6b6b',
                            backgroundColor: 'rgba(255, 107, 107, 0.1)',
                            tension: 0.3,
                            fill: true
                        },
                        {
                            label: 'æ¹¿åº¦ (%)',
                            data: [],
                            borderColor: '#74b9ff',
                            backgroundColor: 'rgba(116, 185, 255, 0.1)',
                            tension: 0.3,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }

        // åŠ è½½å†å²æ¸©æ¹¿åº¦æ•°æ®ï¼ˆç”¨äºåˆå§‹åŒ–å›¾è¡¨ï¼‰
        async function loadDhtData() {
            try {
                const response = await fetch(`${getBaseUrl()}/mqtt/dht/dashboard/${getClientId()}?chartLimit=30`);
                const result = await response.json();

                if (result.code === 0 && result.data) {
                    const data = result.data;

                    // æ›´æ–°å½“å‰å€¼
                    if (data.hasData) {
                        document.getElementById('currentTemp').textContent = data.temperature;
                        document.getElementById('currentHumidity').textContent = data.humidity;
                        document.getElementById('dhtUpdateTime').textContent = data.updateTime;
                    }

                    // æ›´æ–°å›¾è¡¨
                    if (dhtChart && data.labels) {
                        dhtChart.data.labels = data.labels;
                        dhtChart.data.datasets[0].data = data.temperatures;
                        dhtChart.data.datasets[1].data = data.humidities;
                        dhtChart.update();
                    }
                }
            } catch (error) {
                console.error('åŠ è½½æ¸©æ¹¿åº¦æ•°æ®å¤±è´¥:', error);
            }
        }

        // SSEè¿æ¥ç›¸å…³
        let sseConnection = null;

        /**
           * åº”ç”¨é…ç½®åˆ°å‰ç«¯UI
           */
        function applyConfig(config) {
            console.log('========== æ”¶åˆ°è®¾å¤‡é…ç½® ==========');
            console.log('å®Œæ•´é…ç½®å¯¹è±¡:', config);

            // DHTè¯»å–é—´éš”
            if (config.dhtInterval) {
                const select = document.getElementById('dhtInterval');
                if (select) {
                    select.value = config.dhtInterval;
                    console.log('âœ… DHTé—´éš”å·²è®¾ç½®ä¸º:', config.dhtInterval, 'ms');
                } else {
                    console.warn('âš ï¸ dhtIntervalå…ƒç´ æœªæ‰¾åˆ°');
                }
            }

            // LEDäº®åº¦å›æ˜¾
            if (config.ledBrightness !== undefined) {
                const slider = document.getElementById('brightness');
                const valueSpan = document.getElementById('brightnessValue');
                if (slider) {
                    slider.value = config.ledBrightness;
                    if (valueSpan) valueSpan.textContent = config.ledBrightness;
                    console.log('âœ… LEDäº®åº¦å·²è®¾ç½®ä¸º:', config.ledBrightness);
                }
            }

            // WiFié…ç½®å›æ˜¾
            if (config.wifiSsid) {
                const input = document.getElementById('wifiSsid');
                if (input) {
                    input.value = config.wifiSsid;
                    console.log('âœ… WiFi SSID:', config.wifiSsid);
                }
            }

            // MQTTé…ç½®å›æ˜¾
            if (config.mqttBroker) {
                const input = document.getElementById('mqttServer');
                if (input) {
                    input.value = config.mqttBroker;
                    console.log('âœ… MQTTæœåŠ¡å™¨:', config.mqttBroker);
                }
            }
            if (config.mqttPort) {
                const input = document.getElementById('mqttPort');
                if (input) {
                    input.value = config.mqttPort;
                    console.log('âœ… MQTTç«¯å£:', config.mqttPort);
                }
            }

            // è®¾å¤‡çŠ¶æ€ä¿¡æ¯
            if (config.rssi !== undefined) {
                console.log('ï¿½ WiFiä¿¡å·å¼ºåº¦:', config.rssi, 'dBm');
            }
            if (config.uptime !== undefined) {
                console.log('â±ï¸ è¿è¡Œæ—¶é—´:', config.uptime, 'ç§’');
            }
            if (config.freeHeap !== undefined) {
                console.log('ğŸ’¾ ç©ºé—²å†…å­˜:', config.freeHeap, 'bytes');
            }
            if (config.framesize !== undefined) {
                console.log('ğŸ“· æ‘„åƒå¤´åˆ†è¾¨ç‡:', config.framesize);
            }

            // ä¸Šä¼ URLå›æ˜¾
            if (config.uploadUrl) {
                const input = document.getElementById('uploadUrl');
                if (input) {
                    input.value = config.uploadUrl;
                    console.log('âœ… ä¸Šä¼ URL:', config.uploadUrl);
                }
            }

            // === æ›´æ–°è®¾å¤‡çŠ¶æ€é¢æ¿ ===
            // éšè—åŠ è½½åŠ¨ç”»ï¼Œæ˜¾ç¤ºçŠ¶æ€é¢æ¿
            const loadingEl = document.getElementById('deviceStatusLoading');
            const panelEl = document.getElementById('deviceStatusPanel');
            if (loadingEl) loadingEl.style.display = 'none';
            if (panelEl) panelEl.style.display = 'block';

            // è¿è¡Œæ—¶é—´
            if (config.uptime !== undefined) {
                const el = document.getElementById('statusUptime');
                if (el) {
                    const hours = Math.floor(config.uptime / 3600);
                    const mins = Math.floor((config.uptime % 3600) / 60);
                    const secs = config.uptime % 60;
                    el.textContent = hours > 0 ? `${hours}h ${mins}m` : `${mins}m ${secs}s`;
                }
            }

            // ç©ºé—²å†…å­˜
            if (config.freeHeap !== undefined) {
                const el = document.getElementById('statusFreeHeap');
                if (el) el.textContent = (config.freeHeap / 1024).toFixed(1) + 'KB';
            }

            // WiFiä¿¡å·
            if (config.rssi !== undefined) {
                const el = document.getElementById('statusRssi');
                if (el) el.textContent = config.rssi + ' dBm';
            }

            // LEDäº®åº¦
            if (config.ledBrightness !== undefined) {
                const el = document.getElementById('statusLedBrightness');
                if (el) el.textContent = config.ledBrightness;
            }

            // åˆ†è¾¨ç‡
            if (config.framesize !== undefined) {
                const el = document.getElementById('statusFramesize');
                const resolutions = { 0: 'QQVGA', 3: 'HQVGA', 5: 'QVGA', 6: 'CIF', 7: 'VGA', 8: 'SVGA', 9: 'XGA', 10: 'SXGA', 11: 'UXGA', 13: 'FHD' };
                if (el) el.textContent = resolutions[config.framesize] || config.framesize;
            }

            // DHTé—´éš”
            if (config.dhtInterval !== undefined) {
                const el = document.getElementById('statusDhtInterval');
                if (el) el.textContent = (config.dhtInterval / 1000) + 's';
            }

            console.log('======================================');
        }

        // åˆ·æ–°é…ç½®ï¼ˆæ‰‹åŠ¨è§¦å‘ï¼‰
        function refreshConfig() {
            const clientId = getClientId();
            console.log('æ‰‹åŠ¨åˆ·æ–°é…ç½®:', clientId);

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const loadingEl = document.getElementById('deviceStatusLoading');
            const panelEl = document.getElementById('deviceStatusPanel');
            if (loadingEl) loadingEl.style.display = 'block';
            if (panelEl) panelEl.style.display = 'none';

            // å‘é€get_configå‘½ä»¤
            fetch(`${getBaseUrl()}/mqtt/cam/${clientId}/get_config`, { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    console.log('åˆ·æ–°é…ç½®è¯·æ±‚å·²å‘é€:', data);
                    showResult('åˆ·æ–°é…ç½®', data);
                })
                .catch(e => {
                    console.error('åˆ·æ–°é…ç½®å¤±è´¥:', e);
                    showResult('åˆ·æ–°é…ç½®å¤±è´¥', { error: e.message }, true);
                });
        }

        // å»ºç«‹SSEè¿æ¥æ¥æ”¶å®æ—¶æ¸©æ¹¿åº¦æ•°æ®
        function connectSSE() {
            const clientId = getClientId();
            const sseUrl = `${getBaseUrl()}/mqtt/sse/dht/${clientId}`;

            // å…³é—­å·²æœ‰è¿æ¥
            if (sseConnection) {
                sseConnection.close();
            }

            console.log('å»ºç«‹SSEè¿æ¥:', sseUrl);
            sseConnection = new EventSource(sseUrl);

            // è¿æ¥æˆåŠŸ
            sseConnection.addEventListener('connected', (event) => {
                console.log('SSEè¿æ¥æˆåŠŸ:', event.data);
                document.getElementById('sseStatus').innerHTML = 'ğŸŸ¢ åœ¨çº¿';
                document.getElementById('sseStatus').style.color = '#4caf50';
            });

            // æ¥æ”¶æ¸©æ¹¿åº¦æ•°æ®
            sseConnection.addEventListener('dht', (event) => {
                try {
                    const data = JSON.parse(event.data);
                    // æ›´æ–°å½“å‰å€¼æ˜¾ç¤º
                    document.getElementById('currentTemp').textContent = data.temperature.toFixed(2);
                    document.getElementById('currentHumidity').textContent = data.humidity.toFixed(2);
                    document.getElementById('dhtUpdateTime').textContent = data.time;

                    // æ›´æ–°å›¾è¡¨ï¼ˆè¿½åŠ æ–°æ•°æ®ç‚¹ï¼‰
                    if (dhtChart) {
                        // ä¿æŒæœ€å¤š30ä¸ªæ•°æ®ç‚¹
                        if (dhtChart.data.labels.length >= 30) {
                            dhtChart.data.labels.shift();
                            dhtChart.data.datasets[0].data.shift();
                            dhtChart.data.datasets[1].data.shift();
                        }
                        dhtChart.data.labels.push(data.time);
                        dhtChart.data.datasets[0].data.push(data.temperature);
                        dhtChart.data.datasets[1].data.push(data.humidity);
                        dhtChart.update('none'); // ä¸å¸¦åŠ¨ç”»æ›´æ–°ï¼Œæ›´æµç•…
                    }
                } catch (e) {
                    console.error('è§£æSSEæ•°æ®å¤±è´¥:', e);
                }
            });

            // æ¥æ”¶æ“ä½œæ—¥å¿—
            sseConnection.addEventListener('log', (event) => {
                try {
                    const data = JSON.parse(event.data);
                    console.log('æ”¶åˆ°æ“ä½œæ—¥å¿—:', data);
                    // åœ¨æ—¥å¿—å®¹å™¨é¡¶éƒ¨æ’å…¥æ–°æ—¥å¿—
                    addLogToTop(data);
                } catch (e) {
                    console.error('è§£ææ—¥å¿—å¤±è´¥:', e);
                }
            });

            // æ¥æ”¶è®¾å¤‡é…ç½®
            sseConnection.addEventListener('config', (event) => {
                try {
                    const config = JSON.parse(event.data);
                    console.log('æ”¶åˆ°è®¾å¤‡é…ç½®:', config);
                    applyConfig(config);
                } catch (e) {
                    console.error('è§£æé…ç½®å¤±è´¥:', e);
                }
            });

            // è¿æ¥é”™è¯¯
            sseConnection.onerror = (error) => {
                console.error('SSEè¿æ¥é”™è¯¯:', error);
                document.getElementById('sseStatus').innerHTML = 'ğŸ”´ ç¦»çº¿';
                document.getElementById('sseStatus').style.color = '#f44336';
                // 5ç§’åé‡è¿
                setTimeout(connectSSE, 5000);
            };
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–å›¾è¡¨ã€åŠ è½½å†å²æ•°æ®å¹¶å»ºç«‹SSEè¿æ¥
        window.addEventListener('DOMContentLoaded', () => {
            initDhtChart();
            loadDhtData();  // åŠ è½½å†å²æ•°æ®
            connectSSE();   // å»ºç«‹SSEå®æ—¶æ¨é€

            // LEDäº®åº¦æ»‘å—ï¼šæ»‘åŠ¨ç»“æŸè‡ªåŠ¨è®¾ç½®ï¼ˆä¸éœ€è¦ç‚¹å‡»æŒ‰é’®ï¼‰
            const brightnessSlider = document.getElementById('brightness');
            if (brightnessSlider) {
                brightnessSlider.addEventListener('change', (e) => {
                    const value = e.target.value;
                    console.log('LEDäº®åº¦æ»‘å—å˜æ›´:', value);
                    setBrightness();  // è°ƒç”¨ç°æœ‰çš„è®¾ç½®äº®åº¦å‡½æ•°
                });
            }
        });

        // é¡µé¢å…³é—­æ—¶æ–­å¼€SSEè¿æ¥
        window.addEventListener('beforeunload', () => {
            if (sseConnection) {
                sseConnection.close();
            }
        });
    </script>
</body>

</html>