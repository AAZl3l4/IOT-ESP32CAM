# ESP32-CAM MQTT ç‰©è”ç½‘é¡¹ç›®æ¶æ„è¯¦è§£

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªåŸºäºESP32-CAMçš„æ™ºèƒ½æ‘„åƒå¤´ç‰©è”ç½‘ç³»ç»Ÿï¼Œé€šè¿‡MQTTåè®®å®ç°è¿œç¨‹æ§åˆ¶ï¼Œæ”¯æŒ1080pæ‹ç…§ã€è§†é¢‘æµæ¨é€ã€LEDæ§åˆ¶ã€æ‘„åƒå¤´å‚æ•°è°ƒæ•´ç­‰åŠŸèƒ½ã€‚

### æ ¸å¿ƒç‰¹æ€§

- ğŸ¥ **1080pé«˜æ¸…æ‹ç…§** - è¿œç¨‹è§¦å‘æ‹ç…§å¹¶è‡ªåŠ¨ä¸Šä¼ 
- ğŸ“¹ **å¤šåˆ†è¾¨ç‡è§†é¢‘æµ** - æ”¯æŒ480p/720p/1080påˆ‡æ¢
- ğŸ’¡ **LEDæ§åˆ¶** - PWMäº®åº¦è°ƒèŠ‚(0-255)
- ğŸ¨ **æ‘„åƒå¤´å‚æ•°è°ƒæ•´** - äº®åº¦ã€å¯¹æ¯”åº¦ã€é¥±å’Œåº¦ç­‰
- âš™ï¸ **åŠ¨æ€é…ç½®** - WiFiã€MQTTã€ä¸Šä¼ URLå¯è¿œç¨‹ä¿®æ”¹
- ğŸ“Š **çŠ¶æ€ç›‘æ§** - å®æ—¶ä¸ŠæŠ¥è®¾å¤‡è¿è¡ŒçŠ¶æ€

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```mermaid
graph TB
    subgraph "å®¢æˆ·ç«¯"
        A[æµ‹è¯•ç½‘é¡µ<br/>test-panel.html]
        B[ç§»åŠ¨åº”ç”¨/å…¶ä»–å®¢æˆ·ç«¯]
    end
    
    subgraph "Spring Boot åç«¯"
        C[CamController<br/>REST API]
        D[CamService<br/>ä¸šåŠ¡é€»è¾‘]
        E[MqttGateway<br/>MQTTå‘é€]
        F[MqttConfig<br/>MQTTé…ç½®]
    end
    
    subgraph "MQTT Broker"
        G[broker.emqx.io<br/>å…¬å…±MQTTæœåŠ¡å™¨]
    end
    
    subgraph "ESP32-CAM è®¾å¤‡"
        H[WiFiè¿æ¥]
        I[MQTTå®¢æˆ·ç«¯]
        J[æ‘„åƒå¤´æ¨¡å—]
        K[LEDæ§åˆ¶]
        L[Preferences<br/>é…ç½®å­˜å‚¨]
    end
    
    A -->|HTTP POST| C
    B -->|HTTP POST| C
    C --> D
    D --> E
    E -->|å‘å¸ƒæŒ‡ä»¤| G
    G -->|è®¢é˜…æŒ‡ä»¤| I
    I --> J
    I --> K
    I --> L
    J -->|HTTPä¸Šä¼ å›¾ç‰‡| C
    I -->|å‘å¸ƒçŠ¶æ€/ç»“æœ| G
    G -->|è®¢é˜…çŠ¶æ€/ç»“æœ| F
    F --> D
```

---

## ğŸ“ é¡¹ç›®ç»“æ„

### 1. ESP32-CAM å›ºä»¶ (`CameraWebServer/`)

```
CameraWebServer/
â”œâ”€â”€ CameraWebServer.ino     # ä¸»ç¨‹åºï¼ˆ759è¡Œï¼‰
â”œâ”€â”€ app_httpd.cpp           # HTTPè§†é¢‘æµæœåŠ¡å™¨ï¼ˆ160è¡Œï¼‰
â”œâ”€â”€ camera_pins.h           # æ‘„åƒå¤´GPIOå¼•è„šå®šä¹‰
â””â”€â”€ board_config.h          # æ¿å‹é…ç½®ï¼ˆAI-Thinkerï¼‰
```

#### æ ¸å¿ƒä»£ç è§£æ

##### CameraWebServer.ino - ä¸»ç¨‹åº

**1. é…ç½®ç®¡ç† (ä½¿ç”¨Preferences)**

```cpp
// é»˜è®¤é…ç½®ï¼ˆé¦–æ¬¡å¯åŠ¨ï¼‰
#define DEFAULT_WIFI_SSID "2702"
#define DEFAULT_WIFI_PASS "18063328637"
#define DEFAULT_MQTT_SERVER "broker.emqx.io"
#define DEFAULT_MQTT_CLIENT "esp32cam"
#define DEFAULT_UPLOAD_URL "http://192.168.124.68:8080/mqtt/cam/upload"

// è¿è¡Œæ—¶é…ç½®ï¼ˆä»FlashåŠ è½½æˆ–ä½¿ç”¨é»˜è®¤å€¼ï¼‰
String wifi_ssid;
String mqtt_server;
String upload_url;
Preferences preferences;  // ESP32æŒä¹…åŒ–å­˜å‚¨
```

**ä½œç”¨**: 
- ä½¿ç”¨ESP32çš„NVSï¼ˆéæ˜“å¤±æ€§å­˜å‚¨ï¼‰ä¿å­˜é…ç½®
- æ–­ç”µåé…ç½®ä¸ä¸¢å¤±
- å¯é€šè¿‡MQTTè¿œç¨‹ä¿®æ”¹

**2. MQTTæ¶ˆæ¯å¤„ç†æµç¨‹**

```cpp
void mqttCallback(char* topic, byte* payload, unsigned int length) {
    // 1. æ¥æ”¶MQTTæ¶ˆæ¯
    // 2. è§£æJSON {"id":123,"op":"capture","val":0}
    // 3. è°ƒç”¨handleCommandå¤„ç†
}

void handleCommand(StaticJsonDocument<512>& doc) {
    long cmdId = doc["id"].as<long>();  // å…³é”®ï¼šä½¿ç”¨as<long>()
    const char* op = doc["op"];
    
    // æ ¹æ®opç±»å‹åˆ†å‘ï¼š
    // - capture: æ‹ç…§ä¸Šä¼ 
    // - led: LEDæ§åˆ¶
    // - set_wifi: WiFié…ç½®
    // - framesize: åˆ†è¾¨ç‡åˆ‡æ¢
    // ...
}
```

**cmdIdå¤„ç†**: 
- ä½¿ç”¨`.as<long>()`æ˜¾å¼è½¬æ¢ï¼ˆå…³é”®ï¼ï¼‰
- ESP32çš„longæ˜¯32ä½ï¼Œæœ€å¤§2,147,483,647
- åç«¯ä½¿ç”¨`generateCmdId()`ç”Ÿæˆ10ä½æ•°å­—

**3. æ‹ç…§ä¸ä¸Šä¼ **

```cpp
void captureAndUpload(long cmdId) {
    // 1. ä¸´æ—¶åˆ‡æ¢åˆ°1080p
    sensor_t *s = esp_camera_sensor_get();
    framesize_t old_framesize = s->status.framesize;
    s->set_framesize(s, FRAMESIZE_FHD);  // 1080p
    
    // 2. æ‹ç…§
    camera_fb_t *fb = esp_camera_fb_get();
    
    // 3. HTTPä¸Šä¼ 
    uploadImage(fb, cmdId);
    
    // 4. æ¢å¤åŸåˆ†è¾¨ç‡
    esp_camera_fb_return(fb);
    s->set_framesize(s, old_framesize);
}
```

**å…³é”®ç‚¹**:
- æ‹ç…§ç”¨1080pï¼Œè§†é¢‘æµç”¨720p
- æ‹ç…§å®Œæ¯•æ¢å¤åŸåˆ†è¾¨ç‡
- ä½¿ç”¨ç‹¬ç«‹WiFiClienté¿å…ä¸MQTTå†²çª

**4. HTTPå›¾ç‰‡ä¸Šä¼ **

```cpp
void uploadImage(camera_fb_t *fb, long cmdId) {
    // 1. åˆ›å»ºç‹¬ç«‹å®¢æˆ·ç«¯ï¼ˆé¿å…ä¸MQTTå†²çªï¼‰
    WiFiClient httpClient;
    HTTPClient http;
    
    // 2. æ„å»ºæ–‡ä»¶å
    char fileName[64];
    snprintf(fileName, sizeof(fileName), "%s_%ld.jpg", 
             mqtt_client_id.c_str(), cmdId);
    
    // 3. æ„å»ºmultipart/form-data
    String boundary = "----WebKitFormBoundary...";
    // body + å›¾ç‰‡æ•°æ® + endBoundary
    
    // 4. ä¸€æ¬¡æ€§POSTä¸Šä¼ 
    int httpCode = http.POST(postData, totalLen);
}
```

**ä¸ºä»€ä¹ˆç”¨ç‹¬ç«‹WiFiClient**: 
- MQTTä½¿ç”¨`espClient`
- HTTPä¸Šä¼ ä½¿ç”¨`httpClient`
- é¿å…è¿æ¥å†²çªå¯¼è‡´æ•°æ®æ··ä¹±

**5. LED PWMæ§åˆ¶**

```cpp
// åˆå§‹åŒ–
#define LED_PIN 4
#define LED_PWM_FREQ 5000
#define LED_PWM_RESOLUTION 8  // 8ä½=0-255

ledcAttach(LED_PIN, LED_PWM_FREQ, LED_PWM_RESOLUTION);

// æ§åˆ¶
void controlLED(int value) {
    ledStatus = (value != 0);
    if (ledStatus) {
        ledcWrite(LED_PIN, ledBrightness);  // PWMè°ƒå…‰
    } else {
        ledcWrite(LED_PIN, 0);
    }
}
```

**PWMåŸç†**:
- é¢‘ç‡5000Hz
- å ç©ºæ¯”0-255å¯¹åº”äº®åº¦
- GPIO 4è¿æ¥LED

##### app_httpd.cpp - è§†é¢‘æµæœåŠ¡å™¨

**æ ¸å¿ƒåŠŸèƒ½**: æä¾›MJPEGè§†é¢‘æµ

```cpp
static esp_err_t stream_handler(httpd_req_t *req) {
    while (true) {
        // 1. è·å–æ‘„åƒå¤´å¸§
        fb = esp_camera_fb_get();
        
        // 2. å‘é€MJPEGå¤´
        httpd_resp_send_chunk(req, _STREAM_PART, strlen(_STREAM_PART));
        
        // 3. å‘é€JPEGæ•°æ®
        httpd_resp_send_chunk(req, (const char *)fb->buf, fb->len);
        
        // 4. å‘é€è¾¹ç•Œ
        httpd_resp_send_chunk(req, _STREAM_BOUNDARY, strlen(_STREAM_BOUNDARY));
        
        esp_camera_fb_return(fb);
    }
}
```

**è®¿é—®**: `http://{ESP32_IP}/stream`

---

### 2. Spring Boot åç«¯ (`SpringbootIOT/`)

```
SpringbootIOT/
â”œâ”€â”€ src/main/java/com/springboot/
â”‚   â”œâ”€â”€ SpringbootApplication.java        # å¯åŠ¨ç±»
â”‚   â”œâ”€â”€ common/
â”‚   â”‚   â””â”€â”€ Result.java                   # ç»Ÿä¸€è¿”å›ç±»
â”‚   â”œâ”€â”€ configuration/
â”‚   â”‚   â”œâ”€â”€ MqttConfig.java              # MQTTé…ç½®
â”‚   â”‚   â”œâ”€â”€ MqttGateway.java             # MQTTå‘é€æ¥å£
â”‚   â”‚   â””â”€â”€ Blocker.java                 # HTTPæ‹¦æˆªå™¨
â”‚   â”œâ”€â”€ controller/
â”‚   â”‚   â””â”€â”€ CamController.java           # REST APIæ§åˆ¶å™¨
â”‚   â”œâ”€â”€ service/
â”‚   â”‚   â”œâ”€â”€ CamService.java              # æœåŠ¡æ¥å£
â”‚   â”‚   â””â”€â”€ Impl/
â”‚   â”‚       â””â”€â”€ CamServiceImpl.java      # æœåŠ¡å®ç°
â”‚   â”œâ”€â”€ dto/                              # è¯·æ±‚å‚æ•°DTO
â”‚   â”‚   â”œâ”€â”€ LedRequest.java
â”‚   â”‚   â”œâ”€â”€ WiFiConfigRequest.java
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ pojo/
â”‚   â”‚   â”œâ”€â”€ DeviceStatus.java           # è®¾å¤‡çŠ¶æ€å®ä½“
â”‚   â”‚   â””â”€â”€ ResultDto.java              # MQTTç»“æœå®ä½“
â”‚   â”œâ”€â”€ exception/
â”‚   â”‚   â””â”€â”€ GlobalExceptionHandler.java # å…¨å±€å¼‚å¸¸å¤„ç†
â”‚   â””â”€â”€ utils/
â”‚       â””â”€â”€ JsonUtil.java                # JSONå·¥å…·ç±»
â”œâ”€â”€ src/main/resources/
â”‚   â””â”€â”€ application.yml                   # é…ç½®æ–‡ä»¶
â””â”€â”€ pom.xml                               # Mavenä¾èµ–
```

#### æ ¸å¿ƒä»£ç è§£æ

##### 1. Result ç»Ÿä¸€è¿”å›ç±»

```java
public class Result<T> {
    private Integer code;      // 0=æˆåŠŸ
    private String message;
    private T data;
    private Long timestamp;
    
    // é™æ€å·¥å‚æ–¹æ³•
    public static <T> Result<T> success(T data) {
        return new Result<>(0, "æ“ä½œæˆåŠŸ", data);
    }
    
    public static <T> Result<T> error(String message) {
        return new Result<>(500, message, null);
    }
}
```

**ä¼˜åŠ¿**:
- ç»Ÿä¸€APIå“åº”æ ¼å¼
- æ³›å‹æ”¯æŒä»»æ„æ•°æ®ç±»å‹
- è‡ªåŠ¨æ·»åŠ æ—¶é—´æˆ³

##### 2. MqttConfig - MQTTé…ç½®

```java
@Configuration
public class MqttConfig {
    // MQTTæœåŠ¡å™¨åœ°å€
    @Value("${mqtt.url}")
    private String url;
    
    // å‡ºç«™é€šé“ï¼ˆå‘é€æŒ‡ä»¤åˆ°ESP32ï¼‰
    @Bean
    @ServiceActivator(inputChannel = "cmdOutboundChannel")
    public MessageHandler cmdOutbound(MqttPahoClientFactory factory) {
        MqttPahoMessageHandler handler = 
            new MqttPahoMessageHandler("spring-cam-cmd", factory);
        handler.setAsync(true);
        return handler;
    }
    
    // å…¥ç«™é€šé“ï¼ˆæ¥æ”¶ESP32æ¶ˆæ¯ï¼‰
    @Bean
    public MessageProducer inbound(MqttPahoClientFactory factory) {
        MqttPahoMessageDrivenChannelAdapter adapter =
            new MqttPahoMessageDrivenChannelAdapter("spring-cam-result", 
                factory, "cam/+/result", "cam/+/status");
        adapter.setOutputChannel(mqttInputChannel());
        return adapter;
    }
}
```

**æ¶ˆæ¯æµ**:
1. Controller â†’ Service â†’ MqttGateway â†’ cmdOutboundChannel â†’ MQTT Broker
2. MQTT Broker â†’ inbound â†’ mqttInputChannel â†’ CamServiceImpl.handle()

##### 3. CamController - REST API

```java
@RestController
@RequestMapping("/mqtt")
public class CamController {
    
    @PostMapping("/capture/{clientId}")
    public Result<String> capture(@PathVariable @NotBlank String clientId) {
        String cmdId = camService.triggerCapture(clientId);
        return Result.success("æ‹ç…§æŒ‡ä»¤å·²å‘é€", cmdId);
    }
    
    @PostMapping("/led/{clientId}")
    public Result<String> led(
            @PathVariable @NotBlank String clientId,
            @RequestBody @Valid LedRequest request) {  // JSON Body
        String cmdId = camService.controlLed(clientId, request.getValue());
        return Result.success("LEDæ§åˆ¶æŒ‡ä»¤å·²å‘é€", cmdId);
    }
}
```

**å…³é”®å˜åŒ–**:
- ä½¿ç”¨`@RequestBody`æ¥æ”¶JSON
- ä½¿ç”¨`@Valid`è‡ªåŠ¨æ ¡éªŒå‚æ•°
- è¿”å›ç±»å‹ç»Ÿä¸€ä¸º`Result<T>`

##### 4. CamServiceImpl - ä¸šåŠ¡é€»è¾‘

```java
@Service
public class CamServiceImpl implements CamService {
    
    // è®¾å¤‡çŠ¶æ€ç¼“å­˜
    private final ConcurrentHashMap<String, DeviceStatus> deviceStatusCache = 
        new ConcurrentHashMap<>();
    
    // ç”ŸæˆçŸ­IDï¼ˆ32ä½longèŒƒå›´å†…ï¼‰
    private long generateCmdId() {
        long timestamp = System.currentTimeMillis();
        int timePart = (int)(timestamp % 1000000);  // å6ä½
        int randomPart = (int)(Math.random() * 10000);  // 4ä½éšæœº
        return timePart * 10000L + randomPart;  // 10ä½æ•°å­—
    }
    
    @Override
    public String triggerCapture(String clientId) {
        long id = generateCmdId();  // 5741231234
        String json = JsonUtil.toJson(
            Map.of("id", id, "op", "capture", "val", 0));
        mqttGateway.send("cam/" + clientId + "/cmd", json);
        return "cmd queued " + id;
    }
    
    // æ¥æ”¶ESP32æ¶ˆæ¯
    @ServiceActivator(inputChannel = "mqttInputChannel")
    public void handle(Message<?> msg) {
        String topic = (String) msg.getHeaders().get(MqttHeaders.RECEIVED_TOPIC);
        String json = (String) msg.getPayload();
        
        if (topic.endsWith("/result")) {
            // å¤„ç†æ‰§è¡Œç»“æœ
            ResultDto r = JsonUtil.fromJson(json, ResultDto.class);
            log.info("æŒ‡ä»¤{}æ‰§è¡Œå®Œæˆ", r.getId());
        } else if (topic.endsWith("/status")) {
            // æ›´æ–°è®¾å¤‡çŠ¶æ€ç¼“å­˜
            DeviceStatus status = JsonUtil.fromJson(json, DeviceStatus.class);
            deviceStatusCache.put(status.getClientId(), status);
        }
    }
}
```

**cmdIdç”Ÿæˆå…³é”®**:
- `System.currentTimeMillis()` = 1733574123456 (13ä½)
- ESP32çš„longæ˜¯32ä½ â†’ **æº¢å‡ºï¼**
- æ–°æ–¹æ¡ˆï¼š`574123 Ã— 10000 + 1234` = `5741231234` (10ä½)
- å®Œå…¨ç¬¦åˆ32ä½longèŒƒå›´

##### 5. è¯·æ±‚DTO - å‚æ•°æ ¡éªŒ

```java
@Data
public class LedRequest {
    @NotNull(message = "LEDçŠ¶æ€ä¸èƒ½ä¸ºç©º")
    @Min(value = 0, message = "LEDçŠ¶æ€å¿…é¡»ä¸º0æˆ–1")
    @Max(value = 1, message = "LEDçŠ¶æ€å¿…é¡»ä¸º0æˆ–1")
    private Integer value;
}

@Data
public class WiFiConfigRequest {
    @NotBlank(message = "SSIDä¸èƒ½ä¸ºç©º")
    @Size(min = 1, max = 32, message = "SSIDé•¿åº¦å¿…é¡»åœ¨1-32å­—ç¬¦ä¹‹é—´")
    private String ssid;
    
    @NotBlank(message = "å¯†ç ä¸èƒ½ä¸ºç©º")
    @Size(min = 1, max = 64, message = "å¯†ç é•¿åº¦å¿…é¡»åœ¨1-64å­—ç¬¦ä¹‹é—´")
    private String password;
}
```

**è‡ªåŠ¨æ ¡éªŒ**:
- ä½¿ç”¨Bean Validationæ³¨è§£
- GlobalExceptionHandlerç»Ÿä¸€å¤„ç†æ ¡éªŒå¼‚å¸¸
- è¿”å›400é”™è¯¯å’Œæ˜ç¡®æç¤º

##### 6. GlobalExceptionHandler - å¼‚å¸¸å¤„ç†

```java
@RestControllerAdvice
public class GlobalExceptionHandler {
    
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public Result<Void> handleValidationException(
            MethodArgumentNotValidException e) {
        String message = e.getBindingResult()
            .getFieldError().getDefaultMessage();
        return Result.error(400, message);
    }
}
```

**ç»Ÿä¸€é”™è¯¯å“åº”**:
```json
{
  "code": 400,
  "message": "LEDçŠ¶æ€å¿…é¡»ä¸º0æˆ–1",
  "data": null,
  "timestamp": 1733574123456
}
```

---

### 3. æµ‹è¯•é¡µé¢ (`test-panel.html`)

**æŠ€æœ¯æ ˆ**: çº¯HTML + CSS + JavaScript

**æ ¸å¿ƒåŠŸèƒ½**:
```javascript
// APIè°ƒç”¨å°è£…
async function apiCall(url, method = 'POST', body = null) {
    const options = { method };
    if (body) {
        options.headers = { 'Content-Type': 'application/json' };
        options.body = JSON.stringify(body);  // JSON Body
    }
    const response = await fetch(url, options);
    return await response.json();
}

// LEDæ§åˆ¶ç¤ºä¾‹
async function ledControl(value) {
    await apiCall(`${getBaseUrl()}/mqtt/led/${getClientId()}`, 
        'POST', {value});  // {"value": 1}
}

// è§†é¢‘æµæ˜¾ç¤º
function startStream() {
    const ip = document.getElementById('esp32Ip').value;
    document.getElementById('videoStream').src = 
        `http://${ip}/stream?t=${Date.now()}`;
}
```

**è®¾å¤‡çŠ¶æ€å¯è§†åŒ–**:
- è‡ªåŠ¨è§£æstatus JSON
- è®¡ç®—WiFiä¿¡å·å¼ºåº¦å¹¶åˆ†çº§æ˜¾ç¤º
- æ ¼å¼åŒ–è¿è¡Œæ—¶é—´ï¼ˆæ—¶åˆ†ç§’ï¼‰
- æ¯10ç§’è‡ªåŠ¨åˆ·æ–°

---

## ğŸ”„ å®Œæ•´æ•°æ®æµç¤ºä¾‹

### åœºæ™¯1: è¿œç¨‹æ‹ç…§

```
1. ç”¨æˆ·ç‚¹å‡»"æ‹ç…§"æŒ‰é’®
   â†“
2. test-panel.html
   POST /mqtt/capture/esp32cam
   â†“
3. CamController.capture()
   â†“
4. CamServiceImpl.triggerCapture()
   ç”ŸæˆcmdId: 5741231234
   â†“
5. MqttGateway.send()
   Topic: cam/esp32cam/cmd
   Payload: {"id":5741231234,"op":"capture","val":0}
   â†“
6. MQTT Broker (broker.emqx.io)
   â†“
7. ESP32è®¢é˜…cam/esp32cam/cmd
   â†“
8. mqttCallback() â†’ handleCommand()
   è§£æ: id=5741231234, op=capture
   â†“
9. captureAndUpload(5741231234)
   - åˆ‡æ¢1080p
   - esp_camera_fb_get()
   - uploadImage(fb, 5741231234)
   â†“
10. HTTP POSTå›¾ç‰‡
    URL: http://192.168.124.68:8080/mqtt/cam/upload
    FileName: esp32cam_5741231234.jpg
    â†“
11. CamController.upload()
    ä¿å­˜åˆ°: photos/esp32cam_5741231234.jpg
    â†“
12. ESP32å‘å¸ƒç»“æœ
    Topic: cam/esp32cam/result
    Payload: {"id":5741231234,"ok":true,"info":"Upload success"}
    â†“
13. CamServiceImpl.handle()
    æ—¥å¿—: æŒ‡ä»¤5741231234æ‰§è¡Œå®Œæˆ
```

### åœºæ™¯2: è®¾å¤‡çŠ¶æ€ä¸ŠæŠ¥

```
1. ESP32æ¯30ç§’è‡ªåŠ¨ä¸ŠæŠ¥
   â†“
2. publishStatus()
   Topic: cam/esp32cam/status
   Payload: {
     "clientId":"esp32cam",
     "uptime":1234,
     "freeHeap":152536,
     "rssi":-43,
     "ledStatus":false,
     "ledBrightness":255,
     "framesize":13
   }
   â†“
3. CamServiceImpl.handle()
   â†“
4. æ›´æ–°deviceStatusCache
   deviceStatusCache.put("esp32cam", status)
   â†“
5. ç”¨æˆ·æŸ¥è¯¢çŠ¶æ€
   GET /mqtt/status/esp32cam
   â†“
6. CamServiceImpl.getDeviceStatus()
   ä»cacheè¯»å–å¹¶è®¡ç®—onlineçŠ¶æ€
   â†“
7. è¿”å›Result
   {
     "code":0,
     "data":{
       "online":true,
       "uptime":"1234",
       "rssi":-43,
       ...
     }
   }
```

---

## ğŸ”§ å…³é”®æŠ€æœ¯ç‚¹

### 1. ESP32 32ä½longé™åˆ¶

**é—®é¢˜**: Javaçš„`System.currentTimeMillis()`è¿”å›13ä½æ•°å­—ï¼Œè¶…å‡ºESP32 32ä½longèŒƒå›´

**è§£å†³**:
```java
// Javaç«¯
private long generateCmdId() {
    long timestamp = System.currentTimeMillis();  // 1733574123456
    int timePart = (int)(timestamp % 1000000);    // 574123
    int randomPart = (int)(Math.random() * 10000); // 1234
    return timePart * 10000L + randomPart;         // 5741231234
}

// ESP32ç«¯
long cmdId = doc["id"].as<long>();  // æ­£ç¡®è§£æ
```

### 2. HTTPä¸MQTTè¿æ¥éš”ç¦»

```cpp
// MQTTå®¢æˆ·ç«¯ï¼ˆå…¨å±€ï¼‰
WiFiClient espClient;
PubSubClient mqttClient(espClient);

// HTTPå®¢æˆ·ç«¯ï¼ˆå±€éƒ¨ï¼‰
void uploadImage() {
    WiFiClient httpClient;  // ç‹¬ç«‹å®¢æˆ·ç«¯
    HTTPClient http;
    http.begin(httpClient, upload_url);  // é¿å…å†²çª
}
```

### 3. æ‘„åƒå¤´é‡å½±é—®é¢˜

**åŸå› **: åŒç¼“å†²+GRAB_LATESTè·å–åˆ°æ—§å¸§

**è§£å†³**:
```cpp
config.fb_count = 1;  // å•ç¼“å†²
config.grab_mode = CAMERA_GRAB_WHEN_EMPTY;  // ç­‰å¾…æ–°å¸§
```

### 4. åŠ¨æ€é…ç½®æŒä¹…åŒ–

```cpp
// ESP32 Preferencesï¼ˆç±»ä¼¼Android SharedPreferencesï¼‰
Preferences preferences;

void saveWiFiConfig(String ssid, String pass) {
    preferences.begin("esp32cam", false);  // è¯»å†™æ¨¡å¼
    preferences.putString("wifi_ssid", ssid);
    preferences.putString("wifi_pass", pass);
    preferences.end();
    ESP.restart();  // é‡å¯åº”ç”¨æ–°é…ç½®
}

void loadConfig() {
    preferences.begin("esp32cam", true);  // åªè¯»æ¨¡å¼
    wifi_ssid = preferences.getString("wifi_ssid", DEFAULT_WIFI_SSID);
    preferences.end();
}
```

**å­˜å‚¨ä½ç½®**: ESP32ç‰‡ä¸ŠFlashçš„NVSåˆ†åŒºï¼Œæ–­ç”µä¸ä¸¢å¤±

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| 1080pæ‹ç…§æ—¶é—´ | ~2-3ç§’ |
| å›¾ç‰‡å¤§å° | 150-250KB |
| HTTPä¸Šä¼ é€Ÿåº¦ | ~100KB/s |
| 720pè§†é¢‘æµå¸§ç‡ | 15-25 FPS |
| MQTTå»¶è¿Ÿ | <100ms |
| ESP32å†…å­˜å ç”¨ | ~150KBç©ºé—² |
| è®¾å¤‡å¯åŠ¨æ—¶é—´ | ~5-10ç§’ |

---

## âœ… æ€»ç»“

**æŠ€æœ¯æ ˆ**:
- **ESP32å›ºä»¶**: C++, Arduino, ESP-IDF
- **åç«¯**: Spring Boot 3.5, MQTT, MyBatis-Plus
- **å‰ç«¯**: HTML5, CSS3, JavaScript ES6
- **é€šä¿¡**: MQTT (æŒ‡ä»¤), HTTP (å›¾ç‰‡/è§†é¢‘)
- **å­˜å‚¨**: NVS (ESP32), FileSystem (åç«¯)

**è®¾è®¡äº®ç‚¹**:
- ğŸ“¡ MQTTè½»é‡çº§é€šä¿¡
- ğŸ” å‚æ•°æ ¡éªŒä¸å¼‚å¸¸å¤„ç†
- ğŸ’¾ åŠ¨æ€é…ç½®æŒä¹…åŒ–
- ğŸ“Š å®æ—¶çŠ¶æ€ç›‘æ§
- ğŸ¨ ç¾è§‚çš„æµ‹è¯•ç•Œé¢
- ğŸ”§ å®Œå–„çš„æ–‡æ¡£ä½“ç³»

è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„ç‰©è”ç½‘ç³»ç»Ÿï¼Œæ¶µç›–äº†è®¾å¤‡ç«¯ã€æœåŠ¡ç«¯ã€å®¢æˆ·ç«¯ä¸‰å±‚æ¶æ„ï¼
