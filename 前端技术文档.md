# ğŸ¨ å‰ç«¯æŠ€æœ¯æ–‡æ¡£

> test-panel æµ‹è¯•é¢æ¿æŠ€æœ¯è§„èŒƒä¸å¼€å‘æŒ‡å—

## ğŸ“‹ åŠŸèƒ½æ¦‚è§ˆ

| æ¨¡å— | åŠŸèƒ½ | å®ç°æ–¹å¼ |
|------|------|----------|
| **æ‘„åƒå¤´æ§åˆ¶** | æ‹ç…§ã€è§†é¢‘æµã€åˆ†è¾¨ç‡åˆ‡æ¢ | REST API + SSE |
| **LEDæ§åˆ¶** | é—ªå…‰ç¯å¼€å…³ã€äº®åº¦è°ƒèŠ‚ã€æŒ‡ç¤ºç¯ | REST API |
| **çª—æˆ·æ§åˆ¶** | SG90èˆµæœºè§’åº¦æ§åˆ¶ | REST API |
| **é£æ‰‡æ§åˆ¶** | ç»§ç”µå™¨å¼€å…³ | REST API |
| **æ¸©æ¹¿åº¦ç›‘æ§** | å®æ—¶æ•°æ®ã€å†å²å›¾è¡¨ | SSE + Chart.js |
| **è®¾å¤‡çŠ¶æ€** | RSSI/å†…å­˜ç›‘æ§ã€å›¾è¡¨ | SSE + Chart.js |
| **AIåŠ©æ‰‹** | è§†è§‰é—®ç­”ã€å›¾ç‰‡åˆ†æ | REST API + SSE |
| **æ™ºèƒ½è‡ªåŠ¨åŒ–** | æ¸©åº¦/æ¹¿åº¦/å…‰ç…§è”åŠ¨æ§åˆ¶ | å‰ç«¯é…ç½® |

---

## ğŸ”Œ SSEäº‹ä»¶ç›‘å¬

### å»ºç«‹è¿æ¥

```javascript
const sseUrl = `${getBaseUrl()}/mqtt/dht/sse/${getClientId()}`;
sseConnection = new EventSource(sseUrl);
```

### äº‹ä»¶ç±»å‹

| äº‹ä»¶å | æ•°æ®ç»“æ„ | ç”¨é€” |
|--------|----------|------|
| `connected` | `{status, clientId}` | è¿æ¥æˆåŠŸ |
| `dht` | `{temperature, humidity, lightDark, time}` | æ¸©æ¹¿åº¦/å…‰ç…§ |
| `log` | `{clientId, operation, operationDesc, result, resultMsg, time}` | æ“ä½œæ—¥å¿— |
| `config` | DeviceConfigå¯¹è±¡ | è®¾å¤‡é…ç½® |
| `status` | `{rssi, freeHeap, uptime}` | è®¾å¤‡çŠ¶æ€ |
| `capture` | `{clientId, cmdId, imageFile, time}` | æ‹ç…§å®Œæˆ |
| `ai-response` | `{sessionId, taskId, response, imageFile, time}` | AIå“åº” |

### äº‹ä»¶å¤„ç†ç¤ºä¾‹

```javascript
// æ‹ç…§ç»“æœ
sseConnection.addEventListener('capture', (event) => {
    const data = JSON.parse(event.data);
    handleCaptureResult(data);  // åªæœ‰pendingCaptureå­˜åœ¨æ—¶å¼¹çª—
});

// AIå“åº”
sseConnection.addEventListener('ai-response', (event) => {
    const data = JSON.parse(event.data);
    handleAiResponse(data);  // ç§»é™¤ç­‰å¾…æç¤ºï¼Œæ˜¾ç¤ºAIå›ç­”
});
```

---

## ğŸ“¸ æ‹ç…§åŠŸèƒ½

### æµç¨‹

```
ç”¨æˆ·ç‚¹å‡»æ‹ç…§ â†’ è®¾ç½®pendingCapture â†’ è°ƒç”¨/capture API â†’ ç­‰å¾…SSE
                                                         â†“
æ”¶åˆ°captureäº‹ä»¶ â†’ æ£€æŸ¥pendingCapture â†’ æ˜¾ç¤ºé¢„è§ˆ â†’ å¯é€‰AIåˆ†æ
```

### å…³é”®å˜é‡

| å˜é‡ | è¯´æ˜ |
|------|------|
| `pendingCapture` | ç”¨æˆ·æ‰‹åŠ¨æ‹ç…§æ—¶è®¾ç½®ï¼Œç”¨äºåŒºåˆ†æ˜¯å¦å¼¹å‡ºé¢„è§ˆ |
| `currentPreviewImageFile` | å½“å‰é¢„è§ˆçš„å›¾ç‰‡æ–‡ä»¶å |

### é¢„è§ˆæ˜¾ç¤º

- **ä½ç½®**: æ‘„åƒå¤´æ§åˆ¶åŒºåŸŸä¸‹æ–¹å†…åµŒæ˜¾ç¤ºï¼ˆ`#capturePreviewContainer`ï¼‰
- **éå¼¹çª—**: ä¸é®æŒ¡é¡µé¢ï¼Œç”¨æˆ·å¯ç»§ç»­æ“ä½œ
- **AIåˆ†ææŒ‰é’®**: ç´«è‰²æ¸å˜æ ·å¼ï¼Œç‚¹å‡»è°ƒç”¨`/ai/analyze`

---

## ğŸ¤– AIåŠ©æ‰‹

### å¯¹è¯æµç¨‹

```
ç”¨æˆ·å‘é€æ¶ˆæ¯ â†’ æ·»åŠ ç”¨æˆ·æ¶ˆæ¯ â†’ æ˜¾ç¤ºç­‰å¾…æç¤º â†’ è°ƒç”¨/ai/chat(å¼‚æ­¥)
                                                      â†“
æ”¶åˆ°ai-responseäº‹ä»¶ â†’ ç§»é™¤ç­‰å¾…æç¤º â†’ æ˜¾ç¤ºå›¾ç‰‡ â†’ æ˜¾ç¤ºAIå›ç­”
```

### å…³é”®å˜é‡

| å˜é‡ | è¯´æ˜ |
|------|------|
| `AI_SESSION_ID` | ä¼šè¯IDï¼Œé¡µé¢åŠ è½½æ—¶ç”Ÿæˆ |

### addAiMessage(role, content)

| role | æ˜¾ç¤ºæ ·å¼ |
|------|----------|
| `user` | å³å¯¹é½ï¼Œè“è‰²èƒŒæ™¯ |
| `assistant` | å·¦å¯¹é½ï¼Œç™½è‰²èƒŒæ™¯ |
| `system` | å±…ä¸­ï¼Œç°è‰²æ–‡å­— |
| `image` | å›¾ç‰‡å±•ç¤ºï¼Œé€šè¿‡URLè®¿é—® |
| `error` | çº¢è‰²èƒŒæ™¯ |

---

## ğŸ“Š å›¾è¡¨é…ç½® (Chart.js)

### æ¸©æ¹¿åº¦å›¾è¡¨

```javascript
dhtChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: [],  // æ—¶é—´æ ‡ç­¾
        datasets: [
            { label: 'æ¸©åº¦ (Â°C)', borderColor: '#FF6384' },
            { label: 'æ¹¿åº¦ (%)', borderColor: '#36A2EB' }
        ]
    }
});
```

### è®¾å¤‡çŠ¶æ€å›¾è¡¨

- åŒYè½´ï¼šRSSI(å·¦) + å†…å­˜(å³)
- ä¿æŒæœ€å¤š30ä¸ªæ•°æ®ç‚¹

---

## ğŸ”§ APIè°ƒç”¨å°è£…

### apiCallå‡½æ•°

```javascript
async function apiCall(url, method = 'POST', body = null) {
    const options = { method };
    if (body) {
        options.headers = { 'Content-Type': 'application/json' };
        options.body = JSON.stringify(body);
    }
    const response = await fetch(url, options);
    return await response.json();
}
```

### å…³é”®è¾…åŠ©å‡½æ•°

| å‡½æ•° | ç”¨é€” |
|------|------|
| `getBaseUrl()` | è·å–åç«¯åœ°å€ |
| `getClientId()` | è·å–è®¾å¤‡ID |
| `showLoading(btn)` | æŒ‰é’®åŠ è½½çŠ¶æ€ï¼Œè¿”å›done()å›è°ƒ |
| `showToast(message)` | é¡¶éƒ¨æç¤ºæ¶ˆæ¯(3ç§’æ¶ˆå¤±) |

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### SSEè¿æ¥ç®¡ç†

1. **è‡ªåŠ¨é‡è¿**: è¿æ¥æ–­å¼€5ç§’åè‡ªåŠ¨é‡è¿
2. **çŠ¶æ€æŒ‡ç¤º**: åœ¨çº¿/ç¦»çº¿çŠ¶æ€å®æ—¶æ˜¾ç¤º
3. **åªç»´æŠ¤ä¸€ä¸ªè¿æ¥**: åˆ‡æ¢è®¾å¤‡å‰éœ€å…³é—­æ—§è¿æ¥

### æ‹ç…§é¢„è§ˆåŒºåˆ†

| åœºæ™¯ | pendingCapture | æ˜¯å¦æ˜¾ç¤ºé¢„è§ˆ |
|------|----------------|--------------|
| ç”¨æˆ·æ‰‹åŠ¨ç‚¹æ‹ç…§æŒ‰é’® | è®¾ç½® | âœ… æ˜¾ç¤º |
| AIå¯¹è¯è‡ªåŠ¨æ‹ç…§ | null | âŒ ä¸æ˜¾ç¤º |

### å¼‚æ­¥APIæ³¨æ„

- `/ai/chat` å’Œ `/ai/analyze` éƒ½æ˜¯**å¼‚æ­¥**æ¥å£
- ç«‹å³è¿”å›`taskId`ï¼Œç»“æœé€šè¿‡SSEæ¨é€
- éœ€æ­£ç¡®å¤„ç†ç­‰å¾…æç¤ºçš„æ·»åŠ å’Œç§»é™¤

### å›¾ç‰‡è®¿é—®

```javascript
// å›¾ç‰‡URLæ ¼å¼
const imageUrl = `${getBaseUrl()}/file/photos/${imageFile}`;
```

---

## ğŸ“ æ–‡ä»¶ç»“æ„

```
test-panel/
â”œâ”€â”€ test-panel.html    # ä¸»é¡µé¢ç»“æ„
â”œâ”€â”€ test-panel.js      # é€»è¾‘ä»£ç  (~1800è¡Œ)
â””â”€â”€ test-panel.css     # æ ·å¼æ–‡ä»¶
```

### HTMLå…³é”®ID

| ID | ç”¨é€” |
|----|------|
| `capturePreviewContainer` | æ‹ç…§å†…åµŒé¢„è§ˆåŒº |
| `capturePreviewImg` | é¢„è§ˆå›¾ç‰‡ |
| `aiMessages` | AIå¯¹è¯æ¶ˆæ¯å®¹å™¨ |
| `aiMessageInput` | AIè¾“å…¥æ¡† |
| `sseStatus` | SSEè¿æ¥çŠ¶æ€æŒ‡ç¤º |

---

## ğŸ¨ æ ·å¼è§„èŒƒ

### æŒ‰é’®æ ·å¼ç±»

| ç±»å | ç”¨é€” |
|------|------|
| `.btn-primary` | ä¸»è¦æ“ä½œ(è“è‰²) |
| `.btn-success` | æˆåŠŸæ“ä½œ(ç»¿è‰²) |
| `.btn-warning` | è­¦å‘Šæ“ä½œ(æ©™è‰²) |
| `.btn-danger` | å±é™©æ“ä½œ(çº¢è‰²) |
| `.btn-toggle-on/off` | åˆ‡æ¢æŒ‰é’® |

### AIåˆ†ææŒ‰é’®æ ·å¼

```css
background: linear-gradient(135deg, #667eea, #764ba2);
color: white;
border-radius: 8px;
box-shadow: 0 4px 15px rgba(102,126,234,0.4);
```

---

## ğŸ”„ åç»­æ­£å¼å‰ç«¯å¼€å‘å»ºè®®

### æŠ€æœ¯æ ˆæ¨è

- **æ¡†æ¶**: Vue 3 + TypeScript
- **UIåº“**: Element Plus æˆ– Ant Design Vue
- **çŠ¶æ€ç®¡ç†**: Pinia
- **æ„å»ºå·¥å…·**: Vite

### ç»„ä»¶æ‹†åˆ†å»ºè®®

| ç»„ä»¶ | åŠŸèƒ½ |
|------|------|
| `CameraControl.vue` | æ‘„åƒå¤´æ§åˆ¶+é¢„è§ˆ |
| `LedControl.vue` | LEDæ§åˆ¶ |
| `AiAssistant.vue` | AIå¯¹è¯ç•Œé¢ |
| `DhtMonitor.vue` | æ¸©æ¹¿åº¦ç›‘æ§ |
| `DeviceStatus.vue` | è®¾å¤‡çŠ¶æ€ |
| `AutomationPanel.vue` | è‡ªåŠ¨åŒ–é…ç½® |

### SSEå°è£…å»ºè®®

```typescript
// composables/useSse.ts
export function useSse(clientId: string) {
    const connected = ref(false);
    const data = reactive({
        dht: null,
        status: null,
        capture: null,
        aiResponse: null
    });
    
    // EventSourceç®¡ç†...
    
    return { connected, data, connect, disconnect };
}
```

---

## ğŸ“ æ›´æ–°è®°å½•

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´ |
|------|------|------|
| v2.7.0 | 2025-12-29 | å¼‚æ­¥SSEæ¨é€æ¨¡å¼ï¼Œå†…åµŒé¢„è§ˆ |
| v2.6.0 | 2025-12-27 | AIè§†è§‰é—®ç­”åŠŸèƒ½ |
| v2.5.0 | 2025-12-26 | æ™ºèƒ½è‡ªåŠ¨åŒ– |
