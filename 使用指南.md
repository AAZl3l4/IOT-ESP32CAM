# ESP32-CAM MQTT é¡¹ç›®ä½¿ç”¨æŒ‡å—

## ğŸ“ å¿«é€Ÿå¼€å§‹

### ä¸€ã€ESP32-CAM é…ç½®

#### 1. ä¿®æ”¹é…ç½®å‚æ•°

ç¼–è¾‘ `CameraWebServer.ino` æ–‡ä»¶:

```cpp
// WiFié…ç½®
const char *ssid = "ä½ çš„WiFiåç§°";
const char *password = "ä½ çš„WiFiå¯†ç ";

// MQTTé…ç½®
const char *mqtt_server = "broker.emqx.io";  // å¯ä¿æŒä¸å˜æˆ–æ”¹ä¸ºè‡ªå·±çš„MQTTæœåŠ¡å™¨
const int mqtt_port = 1883;
const char *mqtt_client_id = "esp32cam";  // è®¾å¤‡å”¯ä¸€IDï¼Œå¤šä¸ªè®¾å¤‡éœ€è¦ä¸åŒID

// åç«¯æœåŠ¡å™¨é…ç½®
const char *upload_url = "http://192.168.1.100:8080/mqtt/cam/upload";  // ä¿®æ”¹ä¸ºä½ çš„åç«¯IP
```

#### 2. ä¸Šä¼ å›ºä»¶åˆ°ESP32-CAM

ä½¿ç”¨Arduino IDEä¸Šä¼ ä»£ç åˆ°å¼€å‘æ¿ã€‚

#### 3. æŸ¥çœ‹ä¸²å£è¾“å‡º

æ‰“å¼€ä¸²å£ç›‘è§†å™¨(115200æ³¢ç‰¹ç‡)ï¼ŒæŸ¥çœ‹è®¾å¤‡ä¿¡æ¯:

```
ESP32-CAM MQTT IoT Device Starting...
Camera initialized successfully
LED PWM initialized
WiFi connected
IP Address: 192.168.1.xxx
Stream available at: http://192.168.1.xxx/stream
Connecting to MQTT...connected
Subscribed to: cam/esp32cam/cmd
=================================
ESP32-CAM Ready!
Client ID: esp32cam
=================================
```

**è®°å½•ä¸‹ESP32çš„IPåœ°å€ï¼Œç”¨äºè®¿é—®è§†é¢‘æµï¼**

---

### äºŒã€Spring Boot åç«¯é…ç½®

#### 1. ä¿®æ”¹application.yml

```yaml
server:
  port: 8080

mqtt:
  url: tcp://broker.emqx.io:1883  # ä¸ESP32é…ç½®ä¿æŒä¸€è‡´
  user: ""
  pass: ""
  client: spring-cam-${random.value}
```

#### 2. å¯åŠ¨åç«¯

```bash
cd SpringbootIOT
mvn spring-boot:run
```

æˆ–è€…ä½¿ç”¨IDEAç›´æ¥è¿è¡Œ `SpringbootApplication` ä¸»ç±»ã€‚

#### 3. éªŒè¯å¯åŠ¨

æŸ¥çœ‹æ—¥å¿—ï¼Œç¡®è®¤MQTTè¿æ¥æˆåŠŸ:

```
MQTTè¿æ¥æˆåŠŸ
è®¢é˜…topic: cam/+/upload
è®¢é˜…topic: cam/+/result
è®¢é˜…topic: cam/+/status
```

---

## ğŸ® API æ¥å£ä½¿ç”¨

### åŸºç¡€URL

```
http://localhost:8080
```

### 1. æŸ¥çœ‹æ‰€æœ‰API

```bash
GET http://localhost:8080/mqtt/api-docs
```

### 2. æ‹ç…§æ¥å£ (1080p)

```bash
POST http://localhost:8080/mqtt/capture/esp32cam
```

**å“åº”:**
```json
{
  "code": 0,
  "msg": "æ‹ç…§æŒ‡ä»¤å·²å‘é€",
  "data": "cmd queued 1733558400000"
}
```

ç…§ç‰‡ä¼šè‡ªåŠ¨ä¸Šä¼ åˆ° `SpringbootIOT/photos/` ç›®å½•ï¼Œæ–‡ä»¶åæ ¼å¼: `esp32cam_1733558400000.jpg`

### 3. LED å¼€å…³æ§åˆ¶

```bash
# æ‰“å¼€LED
POST http://localhost:8080/mqtt/led/esp32cam?value=1

# å…³é—­LED
POST http://localhost:8080/mqtt/led/esp32cam?value=0
```

### 4. LED äº®åº¦è°ƒèŠ‚

```bash
# è®¾ç½®äº®åº¦ä¸º128 (èŒƒå›´0-255)
POST http://localhost:8080/mqtt/led-brightness/esp32cam?value=128
```

### 5. æ‘„åƒå¤´å‚æ•°è®¾ç½®

```bash
# è°ƒæ•´äº®åº¦
POST http://localhost:8080/mqtt/param/esp32cam?name=brightness&value=1

# è°ƒæ•´å¯¹æ¯”åº¦
POST http://localhost:8080/mqtt/param/esp32cam?name=contrast&value=0

# è°ƒæ•´é¥±å’Œåº¦
POST http://localhost:8080/mqtt/param/esp32cam?name=saturation&value=-1

# è®¾ç½®åˆ†è¾¨ç‡ä¸º720p (ç”¨äºæ¨æµ)
POST http://localhost:8080/mqtt/param/esp32cam?name=framesize&value=11
```

**æ”¯æŒçš„å‚æ•°:**

| å‚æ•°å | è¯´æ˜ | å–å€¼èŒƒå›´ |
|--------|------|----------|
| brightness | äº®åº¦ | -2 to 2 |
| contrast | å¯¹æ¯”åº¦ | -2 to 2 |
| saturation | é¥±å’Œåº¦ | -2 to 2 |
| quality | JPEGè´¨é‡ | 0-63 (è¶Šå°è¶Šå¥½) |
| framesize | åˆ†è¾¨ç‡ | 11=720p, 14=1080p |
| special_effect | ç‰¹æ•ˆ | 0=æ— , 1=è´Ÿç‰‡, 2=é»‘ç™½ |
| wb_mode | ç™½å¹³è¡¡ | 0=è‡ªåŠ¨, 1=æ™´å¤©, 2=é˜´å¤©ç­‰ |
| ae_level | æ›å…‰è¡¥å¿ | -2 to 2 |

### 6. æŸ¥è¯¢è®¾å¤‡çŠ¶æ€

```bash
GET http://localhost:8080/mqtt/status/esp32cam
```

**å“åº”:**
```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "found": true,
    "clientId": "esp32cam",
    "uptime": 1234,
    "freeHeap": 45000,
    "rssi": -45,
    "ledStatus": true,
    "ledBrightness": 128,
    "framesize": 11,
    "lastUpdateTime": 1733558400000,
    "online": true
  }
}
```

### 7. è§†é¢‘æµæ¨é€

æµè§ˆå™¨ç›´æ¥è®¿é—®ESP32çš„IPåœ°å€:

```
http://192.168.1.xxx/stream
```

æ”¯æŒVLCæ’­æ”¾å™¨ã€æµè§ˆå™¨ç­‰ç›´æ¥è§‚çœ‹720p MJPEGæµã€‚

---

## ğŸ§ª æµ‹è¯•ç¤ºä¾‹ (ä½¿ç”¨curl)

### æµ‹è¯•æ‹ç…§
```bash
curl -X POST http://localhost:8080/mqtt/capture/esp32cam
```

### æµ‹è¯•LEDå¼€ç¯
```bash
curl -X POST "http://localhost:8080/mqtt/led/esp32cam?value=1"
```

### æµ‹è¯•äº®åº¦è°ƒèŠ‚
```bash
curl -X POST "http://localhost:8080/mqtt/led-brightness/esp32cam?value=200"
```

### æŸ¥è¯¢è®¾å¤‡çŠ¶æ€
```bash
curl http://localhost:8080/mqtt/status/esp32cam
```

---

## ğŸ“Š MQTT æ¶ˆæ¯æ ¼å¼å‚è€ƒ

### ESP32è®¢é˜…çš„Topic

```
cam/esp32cam/cmd
```

### æŒ‡ä»¤æ¶ˆæ¯æ ¼å¼

**æ‹ç…§æŒ‡ä»¤:**
```json
{"id": 1733558400000, "op": "capture", "val": 0}
```

**LEDå¼€å…³:**
```json
{"id": 1733558400001, "op": "led", "val": 1}
```

**LEDäº®åº¦:**
```json
{"id": 1733558400002, "op": "led_brightness", "val": 128}
```

**å‚æ•°è°ƒæ•´:**
```json
{"id": 1733558400003, "op": "brightness", "val": 1}
```

### ESP32å‘å¸ƒçš„Topic

**æ‰§è¡Œç»“æœ:**
```
Topic: cam/esp32cam/result
Payload: {"id": 1733558400000, "ok": true, "info": "Upload success"}
```

**è®¾å¤‡çŠ¶æ€:**
```
Topic: cam/esp32cam/status
Payload: {
  "clientId": "esp32cam",
  "uptime": 1234,
  "freeHeap": 45000,
  "rssi": -45,
  "ledStatus": true,
  "ledBrightness": 128,
  "framesize": 11
}
```

---

## ğŸ” æ•…éšœæ’æŸ¥

### 1. ESP32æ— æ³•è¿æ¥WiFi

- æ£€æŸ¥SSIDå’Œå¯†ç æ˜¯å¦æ­£ç¡®
- ç¡®è®¤WiFiä¸º2.4GHzé¢‘æ®µ
- æŸ¥çœ‹ä¸²å£è¾“å‡ºçš„é”™è¯¯ä¿¡æ¯

### 2. MQTTè¿æ¥å¤±è´¥

- æ£€æŸ¥MQTT brokeråœ°å€æ˜¯å¦å¯è®¿é—®
- ç¡®è®¤ESP32å’Œåç«¯é…ç½®çš„brokeråœ°å€ä¸€è‡´
- æŸ¥çœ‹åç«¯æ—¥å¿—

### 3. ç…§ç‰‡ä¸Šä¼ å¤±è´¥

- æ£€æŸ¥ `upload_url` ä¸­çš„åç«¯IPåœ°å€æ˜¯å¦æ­£ç¡®
- ç¡®è®¤åç«¯å·²å¯åŠ¨
- æŸ¥çœ‹ESP32ä¸²å£è¾“å‡ºçš„HTTPå“åº”ç 

### 4. è§†é¢‘æµæ— æ³•è®¿é—®

- ç¡®è®¤ESP32å·²æˆåŠŸè¿æ¥WiFi
- æ£€æŸ¥ESP32çš„IPåœ°å€æ˜¯å¦æ­£ç¡®
- å°è¯•é™ä½åˆ†è¾¨ç‡: `framesize=9` (SVGA)

### 5. LEDä¸å·¥ä½œ

- GPIO4å¯èƒ½ä¸SDå¡å†²çª
- æ£€æŸ¥å¼€å‘æ¿å‹å·æ˜¯å¦ä¸ºAI-Thinker
- æŸ¥çœ‹ä¸²å£è¾“å‡ºçš„LEDæ§åˆ¶æ—¥å¿—

---

## ğŸ’¡ ä½¿ç”¨å»ºè®®

1. **ç½‘ç»œå»¶è¿Ÿ**: MQTTå’ŒHTTPè¯·æ±‚éƒ½éœ€è¦ç½‘ç»œï¼Œå»ºè®®ESP32å’Œåç«¯åœ¨åŒä¸€å±€åŸŸç½‘
2. **å†…å­˜ç®¡ç†**: æ‹æ‘„1080pç…§ç‰‡æ—¶ä¼šæš‚æ—¶åœæ­¢æ¨æµï¼Œè¿™æ˜¯æ­£å¸¸çš„
3. **LEDäº®åº¦**: åˆå§‹äº®åº¦ä¸º128ï¼Œå¯æ ¹æ®éœ€è¦è°ƒæ•´
4. **è®¾å¤‡çŠ¶æ€**: ESP32æ¯30ç§’è‡ªåŠ¨ä¸ŠæŠ¥ä¸€æ¬¡çŠ¶æ€
5. **ç…§ç‰‡å‘½å**: ç…§ç‰‡æ–‡ä»¶ååŒ…å«clientIdå’Œæ—¶é—´æˆ³ï¼Œä¾¿äºè¯†åˆ«

---

## ğŸš€ è¿›é˜¶åŠŸèƒ½

### å¤šè®¾å¤‡ç®¡ç†

ä¿®æ”¹ESP32çš„ `mqtt_client_id` ä¸ºä¸åŒå€¼:

```cpp
const char *mqtt_client_id = "esp32cam";  // è®¾å¤‡1
const char *mqtt_client_id = "esp32cam002";  // è®¾å¤‡2
```

ç„¶ååœ¨APIè°ƒç”¨æ—¶ä½¿ç”¨å¯¹åº”çš„clientId:

```bash
POST http://localhost:8080/mqtt/capture/esp32cam002
```

### è‡ªåŠ¨åŒ–è„šæœ¬

ç¼–å†™Pythonè„šæœ¬å®šæ—¶æ‹ç…§:

```python
import requests
import time

while True:
    response = requests.post('http://localhost:8080/mqtt/capture/esp32cam')
    print(response.json())
    time.sleep(60)  # æ¯åˆ†é’Ÿæ‹ä¸€æ¬¡
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

é‡åˆ°é—®é¢˜è¯·æŸ¥çœ‹:
- ESP32ä¸²å£æ—¥å¿—
- Spring Bootåç«¯æ—¥å¿—
- MQTT brokeræ—¥å¿—

ç¥æ‚¨ä½¿ç”¨æ„‰å¿«! ğŸ‰
