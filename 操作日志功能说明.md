# æ“ä½œæ—¥å¿—åŠŸèƒ½å®ç°è¯´æ˜

## âœ… å·²å®Œæˆå†…å®¹

### 1. æ•°æ®åº“è¡¨è®¾è®¡ âœ…
**æ–‡ä»¶**: `sql/schema.sql`

```sql
CREATE TABLE operation_log (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    client_id VARCHAR(64) NOT NULL COMMENT 'è®¾å¤‡ID',
    operation VARCHAR(32) NOT NULL COMMENT 'æ“ä½œç±»å‹',
    operation_desc VARCHAR(255) NOT NULL COMMENT 'æ“ä½œæè¿°(ä¸­æ–‡)',
    cmd_id BIGINT NOT NULL COMMENT 'æŒ‡ä»¤ID',
    result VARCHAR(16) NOT NULL COMMENT 'æ‰§è¡Œç»“æœ',
    result_msg VARCHAR(512) COMMENT 'ç»“æœæ¶ˆæ¯(ä¸­æ–‡)',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
);
```

### 2. å®ä½“ç±»å’Œå·¥å…·ç±» âœ…
- `pojo/OperationLog.java` - æ“ä½œæ—¥å¿—å®ä½“
- `utils/OperationDesc.java` - æ“ä½œæè¿°å·¥å…·ç±»(ä¸­æ–‡è½¬æ¢)

### 3. æ•°æ®è®¿é—®å±‚ âœ…
- `mapper/OperationLogMapper.java` - MyBatis-Plus Mapper

### 4. æœåŠ¡å±‚ âœ…
- `service/OperationLogService.java` - æœåŠ¡æ¥å£
- `service/Impl/OperationLogServiceImpl.java` - æœåŠ¡å®ç°

### 5. æ§åˆ¶å±‚ âœ…
- `controller/OperationLogController.java` - REST API
  - `GET /mqtt/logs/latest?limit=10` - è·å–æœ€æ–°æ—¥å¿—
  - `GET /mqtt/logs/client/{clientId}?limit=10` - æŒ‰è®¾å¤‡è·å–æ—¥å¿—

### 6. é…ç½®æ–‡ä»¶ âœ…
**æ–‡ä»¶**: `src/main/resources/application.yml`

```yaml
spring:
  datasource:
    url: jdbc:mysql://mysql.sqlpub.com:3306/rootus
    username: rootus
    password: iG7kFmlTYNo KaCy7
```

### 7. ESP32è¿”å›æ¶ˆæ¯ä¸­æ–‡åŒ– âœ…
æ‰€æœ‰ `publishResult` æ¶ˆæ¯å·²æ”¹ä¸ºä¸­æ–‡ï¼š
- "Upload success" â†’ "ä¸Šä¼ æˆåŠŸ"
- "LED ON" â†’ "LEDå¼€å¯"
- "Brightness set to 128" â†’ "äº®åº¦è®¾ç½®ä¸º128"
- ç­‰ç­‰...

---

## âš ï¸ éœ€è¦æ‰‹åŠ¨å®Œæˆçš„éƒ¨åˆ†

### 1. ä¿®æ”¹ CamServiceImpl.java

**éœ€è¦åœ¨æ¯ä¸ªæ–¹æ³•ä¸­æ·»åŠ æ—¥å¿—è®°å½•**ã€‚åœ¨æ–‡ä»¶å¼€å¤´å·²ç»æ·»åŠ äº†ï¼š
```java
@Autowired
private com.springboot.service.OperationLogService operationLogService;
```

**ç°åœ¨éœ€è¦åœ¨æ¯ä¸ªæ–¹æ³•ä¸­æ·»åŠ æ—¥å¿—è®°å½•**ï¼š

#### triggerCapture æ–¹æ³• (ç¬¬83-90è¡Œ)
```java
@Override
public String triggerCapture(String clientId) {
    long id = generateCmdId();
    String json = JsonUtil.toJson(Map.of("id", id, "op", "capture", "val", 0));
    mqttGateway.send("cam/" + clientId + "/cmd", json);
    // æ·»åŠ è¿™ä¸€è¡Œ
    operationLogService.log(clientId, "capture", id, 0);
    log.info("å‘é€æ‹ç…§æŒ‡ä»¤: clientId={}, cmdId={}", clientId, id);
    return "cmd queued " + id;
}
```

#### controlLed æ–¹æ³• (çº¦ç¬¬95è¡Œ)
```java
@Override
public String controlLed(String clientId, int value) {
    long id = generateCmdId();
    String json = JsonUtil.toJson(Map.of("id", id, "op", "led", "val", value));
    mqttGateway.send("cam/" + clientId + "/cmd", json);
    // æ·»åŠ è¿™ä¸€è¡Œ
    operationLogService.log(clientId, "led", id, value);
    log.info("å‘é€LEDæ§åˆ¶æŒ‡ä»¤: clientId={}, cmdId={}, value={}", clientId, id, value);
    return "cmd queued " + id;
}
```

#### setLedBrightness æ–¹æ³•
```java
@Override
public String setLedBrightness(String clientId, int value) {
    if (value < 0 || value > 255) {
        throw new IllegalArgumentException("LEDäº®åº¦å€¼å¿…é¡»åœ¨0-255ä¹‹é—´");
    }
    long id = generateCmdId();
    String json = JsonUtil.toJson(Map.of("id", id, "op", "led_brightness", "val", value));
    mqttGateway.send("cam/" + clientId + "/cmd", json);
    // æ·»åŠ è¿™ä¸€è¡Œ
    operationLogService.log(clientId, "led_brightness", id, value);
    log.info("å‘é€LEDäº®åº¦æŒ‡ä»¤: clientId={}, cmdId={}, brightness={}", clientId, id, value);
    return "cmd queued " + id;
}
```

#### setCameraParam æ–¹æ³•
```java
@Override
public String setCameraParam(String clientId, String param, int value) {
    long id = generateCmdId();
    String json = JsonUtil.toJson(Map.of("id", id, "op", param, "val", value));
    mqttGateway.send("cam/" + clientId + "/cmd", json);
    // æ·»åŠ è¿™ä¸€è¡Œ
    operationLogService.log(clientId, param, id, value);
    log.info("å‘é€æ‘„åƒå¤´å‚æ•°æŒ‡ä»¤: clientId={}, cmdId={}, param={}, value={}", 
             clientId, id, param, value);
    return "cmd queued " + id;
}
```

**å…¶ä»–æ–¹æ³•ç±»ä¼¼æ·»åŠ **ã€‚

### 2. åˆ›å»ºæ•°æ®åº“è¡¨

æ‰§è¡Œ `sql/schema.sql` åœ¨MySQLæ•°æ®åº“ä¸­åˆ›å»ºè¡¨ï¼š
```bash
mysql -h mysql.sqlpub.com -P 3306 -u rootus -p rootus < sql/schema.sql
# å¯†ç : iG7kFmlTYNoKaCy7
```

### 3. æµ‹è¯•é¡µé¢æ·»åŠ æ—¥å¿—æ˜¾ç¤º

åœ¨ `test-panel.html` ä¸­æ·»åŠ æ—¥å¿—æ˜¾ç¤ºåŒºåŸŸï¼š

```html
<!-- æ“ä½œæ—¥å¿— -->
<div class="section">
    <h2>ğŸ“œ æ“ä½œæ—¥å¿—</h2>
    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
        <button class="btn-info" onclick="loadLogs()">ğŸ”„ åˆ·æ–°æ—¥å¿—</button>
        <label style="display: flex; align-items: center; gap: 5px;">
            <input type="checkbox" id="autoRefresh">
            <span>è‡ªåŠ¨åˆ·æ–°(5ç§’)</span>
        </label>
    </div>
    <div id="logContainer" style="background: white; border-radius: 8px; max-height: 400px; overflow-y: auto;">
        <!-- æ—¥å¿—å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
    </div>
</div>

<script>
// åŠ è½½æ—¥å¿—
async function loadLogs() {
    try {
        const response = await fetch(`${getBaseUrl()}/mqtt/logs/latest?limit=10`);
        const result = await response.json();
        
        if (result.code === 0 && result.data) {
            displayLogs(result.data);
        }
    } catch (error) {
        console.error('åŠ è½½æ—¥å¿—å¤±è´¥:', error);
    }
}

// æ˜¾ç¤ºæ—¥å¿—
function displayLogs(logs) {
    const container = document.getElementById('logContainer');
    if (logs.length === 0) {
        container.innerHTML = '<p style="padding: 20px; text-align: center; color: #999;">æš‚æ— æ“ä½œæ—¥å¿—</p>';
        return;
    }
    
    let html = '<table style="width: 100%; border-collapse: collapse;">';
    html += `
        <thead>
            <tr style="background: #f5f5f5; border-bottom: 2px solid #ddd;">
                <th style="padding: 10px; text-align: left;">æ—¶é—´</th>
                <th style="padding: 10px; text-align: left;">è®¾å¤‡</th>
                <th style="padding: 10px; text-align: left;">æ“ä½œ</th>
                <th style="padding: 10px; text-align: left;">ç»“æœ</th>
            </tr>
        </thead>
        <tbody>
    `;
    
    logs.forEach(log => {
        const resultColor = log.result === 'success' ? '#4caf50' : 
                           log.result === 'failed' ? '#f44336' : '#ff9800';
        const resultText = log.result === 'success' ? 'âœ“ æˆåŠŸ' : 
                          log.result === 'failed' ? 'âœ— å¤±è´¥' : 'â³ å¤„ç†ä¸­';
        
        html += `
            <tr style="border-bottom: 1px solid #eee;">
                <td style="padding: 10px;">${formatTime(log.createTime)}</td>
                <td style="padding: 10px;">${log.clientId}</td>
                <td style="padding: 10px;">${log.operationDesc}</td>
                <td style="padding: 10px; color: ${resultColor}; font-weight: bold;">
                    ${resultText}${log.resultMsg ? ': ' + log.resultMsg : ''}
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

// æ ¼å¼åŒ–æ—¶é—´
function formatTime(timeStr) {
    const date = new Date(timeStr);
    return `${date.getMonth()+1}-${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2,'0')}:${String(date.getSeconds()).padStart(2,'0')}`;
}

// è‡ªåŠ¨åˆ·æ–°
setInterval(() => {
    if (document.getElementById('autoRefresh').checked) {
        loadLogs();
    }
}, 5000);

// é¡µé¢åŠ è½½æ—¶åŠ è½½æ—¥å¿—
window.addEventListener('DOMContentLoaded', loadLogs);
</script>
```

---

## ğŸ“Š åŠŸèƒ½é¢„è§ˆ

### æ“ä½œæ—¥å¿—è®°å½•æµç¨‹

1. **ç”¨æˆ·ç‚¹å‡»"æ‹ç…§"** 
   â†’ åç«¯è®°å½•: `operationLog{æ“ä½œ:"æ‹ç…§ä¸Šä¼ (1080p)", ç»“æœ:"pending"}`

2. **ESP32æ‰§è¡Œæ‹ç…§å¹¶è¿”å›ç»“æœ**
   â†’ åç«¯æ›´æ–°: `{ç»“æœ:"success", æ¶ˆæ¯:"ä¸Šä¼ æˆåŠŸ"}`

3. **æ—¥å¿—æ˜¾ç¤º**:
   ```
   æ—¶é—´           è®¾å¤‡        æ“ä½œ              ç»“æœ
   12-07 20:50   esp32cam   æ‹ç…§ä¸Šä¼ (1080p)   âœ“ æˆåŠŸ: ä¸Šä¼ æˆåŠŸ
   12-07 20:49   esp32cam   LEDå¼€å¯           âœ“ æˆåŠŸ: LEDå¼€å¯
   12-07 20:48   esp32cam   äº®åº¦è®¾ç½®ä¸º128    âœ“ æˆåŠŸ: äº®åº¦è®¾ç½®ä¸º128
   ```

---

## ğŸš€ å¯åŠ¨æ­¥éª¤

1. **åˆ›å»ºæ•°æ®åº“è¡¨**
2. **ä¿®æ”¹ CamServiceImpl.java** (æ·»åŠ æ—¥å¿—è®°å½•è°ƒç”¨)
3. **é‡å¯Spring Boot**
4. **æµ‹è¯•é¡µé¢æ·»åŠ æ—¥å¿—æ˜¾ç¤ºä»£ç **
5. **æµ‹è¯•åŠŸèƒ½**:
   - ç‚¹å‡»æ‹ç…§
   - æŸ¥çœ‹æ—¥å¿—æ˜¯å¦è®°å½•
   - æ£€æŸ¥ç»“æœæ˜¯å¦æ›´æ–°

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **æ‰€æœ‰ESP32è¿”å›æ¶ˆæ¯å·²æ”¹ä¸ºä¸­æ–‡** âœ…
2. **æ“ä½œæè¿°è‡ªåŠ¨è½¬æ¢ä¸ºä¸­æ–‡** âœ…  
3. **æ—¥å¿—é»˜è®¤æ˜¾ç¤ºæœ€æ–°10æ¡** âœ…
4. **æ”¯æŒè‡ªåŠ¨åˆ·æ–°** (éœ€è¦åœ¨æµ‹è¯•é¡µé¢å®ç°)
5. **æ•°æ®åº“è¿æ¥ä¿¡æ¯å·²é…ç½®** âœ…

---

å®Œæˆè¿™äº›æ­¥éª¤åï¼Œç³»ç»Ÿå°†æ‹¥æœ‰å®Œæ•´çš„æ“ä½œæ—¥å¿—åŠŸèƒ½ï¼Œæ‰€æœ‰æ“ä½œéƒ½ä¼šè¢«è®°å½•å¹¶ä»¥ä¸­æ–‡å‹å¥½æ–¹å¼æ˜¾ç¤ºï¼
