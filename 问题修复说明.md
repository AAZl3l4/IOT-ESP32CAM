# é—®é¢˜ä¿®å¤è¯´æ˜

## ğŸ› é‡åˆ°çš„é—®é¢˜

### é—®é¢˜1: åç«¯å¯åŠ¨å¤±è´¥
**é”™è¯¯ä¿¡æ¯**:
```
ConflictingBeanDefinitionException: bean name 'globalExceptionHandler' conflicts
```

**åŸå› **: å­˜åœ¨ä¸¤ä¸ªGlobalExceptionHandlerç±»
- `com.springboot.configuration.GlobalExceptionHandler` (æ—§)
- `com.springboot.exception.GlobalExceptionHandler` (æ–°)

åŒæ ·Resultç±»ä¹Ÿæœ‰ä¸¤ä¸ªï¼š
- `com.springboot.utils.Result` (æ—§)
- `com.springboot.common.Result` (æ–°)

**è§£å†³æ–¹æ¡ˆ**: âœ… å·²åˆ é™¤æ—§çš„ç±»æ–‡ä»¶
```
åˆ é™¤ configuration/GlobalExceptionHandler.java
åˆ é™¤ utils/Result.java
```

### é—®é¢˜2: ç…§ç‰‡æ–‡ä»¶åé‡å¤
**ç°è±¡**: æ‰€æœ‰ç…§ç‰‡éƒ½å« `esp32cam_0.jpg`

**åŸå› **: cmdIdå¯èƒ½æœªæ­£ç¡®ä¼ é€’

**è§£å†³æ–¹æ¡ˆ**: âœ… æ·»åŠ è°ƒè¯•æ—¥å¿—
- åœ¨ `captureAndUpload` å‡½æ•°æ·»åŠ cmdIdè¾“å‡º
- åœ¨ `uploadImage` å‡½æ•°æ·»åŠ fileNameè¾“å‡º
- æ£€æŸ¥MQTTæ¶ˆæ¯ä¸­çš„idå­—æ®µæ˜¯å¦æ­£ç¡®

### é—®é¢˜3: ç…§ç‰‡ä¸‹æ–¹æœ‰é‡å½±
**åŸå› **: æ‘„åƒå¤´ç¼“å†²åŒºé…ç½®ä¸å½“
- `fb_count = 2` ä½¿ç”¨åŒç¼“å†²
- `CAMERA_GRAB_LATEST` å¯èƒ½è·å–åˆ°æ—§å¸§

**è§£å†³æ–¹æ¡ˆ**: âœ… ä¼˜åŒ–æ‘„åƒå¤´é…ç½®
```cpp
config.fb_count = 1;  // å•ç¼“å†²é¿å…é‡å½±
config.grab_mode = CAMERA_GRAB_WHEN_EMPTY;  // ç­‰å¾…æ–°å¸§
```

---

## ğŸ”§ ä¿®å¤å†…å®¹

### 1. åˆ é™¤å†²çªçš„ç±»æ–‡ä»¶
- âœ… åˆ é™¤ `configuration/GlobalExceptionHandler.java`
- âœ… åˆ é™¤ `utils/Result.java`

### 2. ESP32å›ºä»¶ä¿®æ”¹

#### ä¼˜åŒ–æ‘„åƒå¤´é…ç½®
```cpp
// ä¿®æ”¹å‰
config.fb_count = 2;
config.grab_mode = CAMERA_GRAB_LATEST;

// ä¿®æ”¹å
config.fb_count = 1;  // é¿å…é‡å½±
config.grab_mode = CAMERA_GRAB_WHEN_EMPTY;  // é¿å…æ—§å¸§
```

#### æ·»åŠ è°ƒè¯•æ—¥å¿—
```cpp
void captureAndUpload(long cmdId) {
  Serial.printf("Command ID received: %ld\n", cmdId);  // æ–°å¢
  ...
}

void uploadImage(camera_fb_t *fb, long cmdId) {
  Serial.printf("Filename: %s (cmdId: %ld)\n", fileName, cmdId);  // æ–°å¢
  ...
}
```

---

## ğŸ“ æµ‹è¯•æ­¥éª¤

### 1. é‡å¯åç«¯
```bash
cd SpringbootIOT
mvn spring-boot:run
```

**æ£€æŸ¥ç‚¹**: 
- âœ… åç«¯æˆåŠŸå¯åŠ¨ï¼Œæ— Beanå†²çªé”™è¯¯
- âœ… æ—¥å¿—æ˜¾ç¤º `Started SpringbootApplication`

### 2. é‡æ–°ä¸Šä¼ ESP32å›ºä»¶
1. æ‰“å¼€Arduino IDE
2. ç¼–è¯‘å¹¶ä¸Šä¼  `CameraWebServer.ino`
3. æ‰“å¼€ä¸²å£ç›‘è§†å™¨ï¼ˆæ³¢ç‰¹ç‡115200ï¼‰

### 3. æµ‹è¯•æ‹ç…§åŠŸèƒ½
æ–¹æ³•1 - ä½¿ç”¨æµ‹è¯•é¡µé¢ï¼š
1. æ‰“å¼€ `test-panel.html`
2. ç‚¹å‡» "ğŸ“¸ æ‹ç…§ (1080p)"
3. æŸ¥çœ‹å“åº”ç»“æœ

æ–¹æ³•2 - ä½¿ç”¨curlï¼š
```bash
curl -X POST http://192.168.124.68:8080/mqtt/capture/esp32cam
```

### 4. æ£€æŸ¥ESP32ä¸²å£è¾“å‡º
**æœŸæœ›è¾“å‡º**:
```
MQTT message received [cam/esp32cam/cmd]: {"id":1733574000000,"op":"capture"}
Processing: id=1733574000000, op=capture
Starting capture and upload...
Command ID received: 1733574000000  â† å…³é”®æ—¥å¿—
Captured image: 169400 bytes
Filename: esp32cam_1733574000000.jpg (cmdId: 1733574000000)  â† å…³é”®æ—¥å¿—
HTTP Response code: 200
âœ“ Upload SUCCESS!
```

### 5. æ£€æŸ¥æ–‡ä»¶å
æŸ¥çœ‹ `photos/` ç›®å½•ï¼š
```
esp32cam_1733574000000.jpg  â† æ–‡ä»¶ååº”è¯¥ä¸åŒ
esp32cam_1733574015123.jpg
esp32cam_1733574030456.jpg
```

### 6. æ£€æŸ¥ç…§ç‰‡è´¨é‡
æ‰“å¼€ç…§ç‰‡ï¼Œæ£€æŸ¥ï¼š
- âœ… æ— é‡å½±
- âœ… æ¸…æ™°åº¦æ­£å¸¸
- âœ… äº®åº¦æ­£å¸¸

---

## ğŸ” æ•…éšœæ’æŸ¥

### å¦‚æœæ–‡ä»¶åä»ç„¶é‡å¤

**æ£€æŸ¥åç«¯æ—¥å¿—**:
```
å‘é€æ‹ç…§æŒ‡ä»¤: clientId=esp32cam, cmdId=1733574000000
```

**æ£€æŸ¥ESP32ä¸²å£**:
```
Command ID received: 0  â† å¦‚æœæ˜¯0ï¼Œè¯´æ˜JSONè§£æå¤±è´¥
```

**å¯èƒ½åŸå› **:
1. åç«¯å‘é€çš„JSONæ ¼å¼ä¸å¯¹
2. ESP32çš„ArduinoJsonç‰ˆæœ¬é—®é¢˜
3. MQTTæ¶ˆæ¯ä¼ è¾“é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥MQTTæ¶ˆæ¯å†…å®¹
- åœ¨handleCommandå‡½æ•°æ·»åŠ æ›´å¤šæ—¥å¿—
- æµ‹è¯•ä½¿ç”¨MQTTå®¢æˆ·ç«¯æ‰‹åŠ¨å‘é€æ¶ˆæ¯

### å¦‚æœç…§ç‰‡ä»æœ‰é‡å½±

**å°è¯•æ–¹æ¡ˆ1**: åœ¨æ‹ç…§å‰å»¶è¿Ÿ
```cpp
void captureAndUpload(long cmdId) {
  delay(100);  // ç­‰å¾…100ms
  camera_fb_t *fb = esp_camera_fb_get();
  ...
}
```

**å°è¯•æ–¹æ¡ˆ2**: æ¸…ç©ºæ—§å¸§ç¼“å†²
```cpp
// æ‹ç…§å‰å…ˆè·å–å¹¶ä¸¢å¼ƒä¸€å¸§
camera_fb_t *dummy = esp_camera_fb_get();
if (dummy) esp_camera_fb_return(dummy);

// ç„¶åå†æ‹ç…§
camera_fb_t *fb = esp_camera_fb_get();
```

---

## âœ… éªŒè¯å®Œæˆæ ‡å‡†

- [x] åç«¯æˆåŠŸå¯åŠ¨æ— é”™è¯¯
- [x] ESP32å›ºä»¶æˆåŠŸä¸Šä¼ 
- [ ] æ‹ç…§æ–‡ä»¶åä½¿ç”¨æ—¶é—´æˆ³ï¼ˆä¸é‡å¤ï¼‰
- [ ] ç…§ç‰‡æ— é‡å½±ç°è±¡
- [ ] ç…§ç‰‡è´¨é‡æ¸…æ™°

---

**ä¿®å¤æ—¶é—´**: 2025-12-07 19:45  
**çŠ¶æ€**: ç­‰å¾…æµ‹è¯•éªŒè¯
